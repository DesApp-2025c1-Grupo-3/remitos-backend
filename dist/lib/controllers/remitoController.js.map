{"version":3,"sources":["../../../lib/controllers/remitoController.js"],"names":["includes","require","Remito","Cliente","Destino","Contacto","Estado","Mercaderia","sequelize","message","Op","controller","getRemitos","req","res","page","parseInt","query","limit","offset","where","numeroAsignado","iLike","clienteId","estadoId","prioridad","fechaEmision","year","month","day","split","map","Number","fechaInicio","Date","fechaFin","gte","lte","count","rows","findAndCountAll","include","model","as","order","status","json","data","totalItems","totalPages","Math","ceil","currentPage","error","console","getRemitoById","id","params","remito","findByPk","createRemito","tipoMercaderia","valorDeclarado","volumenMetrosCubico","pesoMercaderia","cantidadBobinas","cantidadRacks","cantidadBultos","cantidadPallets","requisitosEspeciales","observaciones","body","archivoEnviado","file","path","create","archivoAdjunto","createRemitoWithClienteAndDestino","t","transaction","destinoId","nuevaMercaderia","nuevoRemito","mercaderiaId","commit","remitoCompleto","rollback","updateRemito","log","remitoFields","mercaderiaFields","remitoUpdateData","mercaderiaUpdateData","key","update","mercaderia","remitoActualizado","updateEstadoRemito","remitoId","estId","eid","deleteRemito","destroy","getVolumenPorClientePeriodo","fechaDesde","fechaHasta","$between","$gte","$lte","remitos","findAll","resultado","forEach","cliente","razonSocial","volumen","Object","entries","volumenTotal","module","exports"],"mappings":"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","sourcesContent":["const { includes } = require(\"lodash\");\r\nconst {\r\n  Remito,\r\n  Cliente,\r\n  Destino,\r\n  Contacto,\r\n  Estado,\r\n  Mercaderia,\r\n  sequelize,\r\n} = require(\"../models\");\r\nconst { message } = require(\"../schemas/estadoSchema\");\r\nconst { Op } = require(\"sequelize\");\r\nconst controller = {};\r\n\r\nconst getRemitos = async (req, res) => {\r\n  try {\r\n    const page = parseInt(req.query.page, 10) || 1;\r\n    const limit = parseInt(req.query.limit, 10) || 20;\r\n    const offset = (page - 1) * limit;\r\n\r\n    // Filtros\r\n    const where = {};\r\n    if (req.query.numeroAsignado) {\r\n      where.numeroAsignado = { [Op.iLike]: `%${req.query.numeroAsignado}%` };\r\n    }\r\n    if (req.query.clienteId) {\r\n      where.clienteId = req.query.clienteId;\r\n    }\r\n    if (req.query.estadoId) {\r\n      where.estadoId = req.query.estadoId;\r\n    }\r\n    if (req.query.prioridad) {\r\n      where.prioridad = req.query.prioridad;\r\n    }\r\n    if (req.query.fechaEmision) {\r\n      // Buscar por fecha específica (formato YYYY-MM-DD)\r\n      const [year, month, day] = req.query.fechaEmision.split(\"-\").map(Number);\r\n      const fechaInicio = new Date(year, month - 1, day, 0, 0, 0, 0);\r\n      const fechaFin = new Date(year, month - 1, day, 23, 59, 59, 999);\r\n\r\n      where.fechaEmision = {\r\n        [Op.gte]: fechaInicio,\r\n        [Op.lte]: fechaFin,\r\n      };\r\n    }\r\n\r\n    const { count, rows } = await Remito.findAndCountAll({\r\n      where,\r\n      limit,\r\n      offset,\r\n      include: [\r\n        {\r\n          model: Destino,\r\n          as: \"destino\",\r\n        },\r\n        {\r\n          model: Cliente,\r\n          as: \"cliente\",\r\n        },\r\n        {\r\n          model: Estado,\r\n          as: \"estado\",\r\n        },\r\n      ],\r\n      order: [[\"createdAt\", \"DESC\"]],\r\n    });\r\n\r\n    res.status(200).json({\r\n      data: rows,\r\n      totalItems: count,\r\n      totalPages: Math.ceil(count / limit),\r\n      currentPage: page,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error al obtener remitos:\", error);\r\n    res.status(500).json({ message: \"Error al obtener los remitos\" });\r\n  }\r\n};\r\ncontroller.getRemitos = getRemitos;\r\n\r\nconst getRemitoById = async (req, res) => {\r\n  const id = req.params.id;\r\n  const remito = await Remito.findByPk(id, {\r\n    include: [\r\n      {\r\n        model: Destino,\r\n        as: \"destino\",\r\n      },\r\n      {\r\n        model: Cliente,\r\n        as: \"cliente\",\r\n      },\r\n      {\r\n        model: Estado,\r\n        as: \"estado\",\r\n      },\r\n      {\r\n        model: Mercaderia,\r\n        as: \"mercaderia\",\r\n      },\r\n    ],\r\n  });\r\n  res.status(200).json(remito);\r\n};\r\ncontroller.getRemitoById = getRemitoById;\r\n\r\nconst createRemito = async (req, res) => {\r\n  const {\r\n    numeroAsignado,\r\n    tipoMercaderia,\r\n    valorDeclarado,\r\n    volumenMetrosCubico,\r\n    pesoMercaderia,\r\n    cantidadBobinas,\r\n    cantidadRacks,\r\n    cantidadBultos,\r\n    cantidadPallets,\r\n    requisitosEspeciales,\r\n    observaciones,\r\n  } = req.body;\r\n  const fechaEmision = new Date();\r\n  const archivoEnviado = req.file?.path || null;\r\n  const remito = await Remito.create({\r\n    numeroAsignado,\r\n    tipoMercaderia,\r\n    valorDeclarado,\r\n    volumenMetrosCubico,\r\n    pesoMercaderia,\r\n    fechaEmision,\r\n    cantidadBobinas,\r\n    cantidadRacks,\r\n    cantidadBultos,\r\n    cantidadPallets,\r\n    requisitosEspeciales,\r\n    observaciones,\r\n    archivoAdjunto: archivoEnviado,\r\n  });\r\n  res.status(201).json(remito);\r\n};\r\ncontroller.createRemito = createRemito;\r\n\r\nconst createRemitoWithClienteAndDestino = async (req, res) => {\r\n  const t = await sequelize.transaction(); // Iniciar transacción\r\n\r\n  try {\r\n    const {\r\n      numeroAsignado,\r\n      fechaEmision,\r\n      observaciones,\r\n      clienteId,\r\n      destinoId,\r\n      prioridad,\r\n      tipoMercaderia,\r\n      valorDeclarado,\r\n      volumenMetrosCubico,\r\n      pesoMercaderia,\r\n      cantidadBobinas,\r\n      cantidadRacks,\r\n      cantidadBultos,\r\n      cantidadPallets,\r\n      requisitosEspeciales,\r\n    } = req.body;\r\n\r\n    // 1. Crear Mercaderia dentro de la transacción\r\n    const nuevaMercaderia = await Mercaderia.create(\r\n      {\r\n        tipoMercaderia,\r\n        valorDeclarado,\r\n        volumenMetrosCubico,\r\n        pesoMercaderia,\r\n        cantidadBobinas,\r\n        cantidadRacks,\r\n        cantidadBultos,\r\n        cantidadPallets,\r\n        requisitosEspeciales,\r\n      },\r\n      { transaction: t }\r\n    );\r\n\r\n    // 2. Crear Remito dentro de la transacción\r\n    const nuevoRemito = await Remito.create(\r\n      {\r\n        numeroAsignado,\r\n        fechaEmision,\r\n        observaciones,\r\n        prioridad,\r\n        clienteId,\r\n        destinoId,\r\n        mercaderiaId: nuevaMercaderia.id,\r\n        estadoId: 1,\r\n        archivoAdjunto: req.file?.path || null,\r\n      },\r\n      { transaction: t }\r\n    );\r\n\r\n    // Si todo va bien, confirmar la transacción\r\n    await t.commit();\r\n\r\n    // Devolver el remito completo con sus relaciones\r\n    const remitoCompleto = await Remito.findByPk(nuevoRemito.id, {\r\n      include: [\"cliente\", \"destino\", \"estado\", \"mercaderia\"],\r\n    });\r\n\r\n    res.status(201).json(remitoCompleto);\r\n  } catch (error) {\r\n    // Si algo falla, revertir la transacción\r\n    await t.rollback();\r\n    console.error(\r\n      \"Error al crear remito con mercaderia (transacción revertida):\",\r\n      error\r\n    );\r\n    res.status(500).json({ message: \"Error al crear el remito\" });\r\n  }\r\n};\r\ncontroller.createRemitoWithClienteAndDestino = createRemitoWithClienteAndDestino;\r\n\r\nconst updateRemito = async (req, res) => {\r\n  const { id } = req.params;\r\n  const data = req.body;\r\n\r\n  console.log(\"--- Iniciando actualización de Remito ---\");\r\n  console.log(\"ID del Remito:\", id);\r\n  console.log(\"Datos recibidos (req.body):\", data);\r\n\r\n  try {\r\n    const remito = await Remito.findByPk(id);\r\n    if (!remito) {\r\n      console.log(\"Error: Remito no encontrado.\");\r\n      return res.status(404).json({ message: \"Remito no encontrado\" });\r\n    }\r\n\r\n    console.log(\r\n      \"Remito encontrado. ID de mercadería asociada:\",\r\n      remito.mercaderiaId\r\n    );\r\n\r\n    // Definir los campos que pertenecen a cada modelo\r\n    const remitoFields = [\r\n      \"numeroAsignado\",\r\n      \"fechaEmision\",\r\n      \"observaciones\",\r\n      \"prioridad\",\r\n      \"clienteId\",\r\n      \"destinoId\",\r\n      \"estadoId\",\r\n    ];\r\n    const mercaderiaFields = [\r\n      \"tipoMercaderia\",\r\n      \"valorDeclarado\",\r\n      \"volumenMetrosCubico\",\r\n      \"pesoMercaderia\",\r\n      \"cantidadBobinas\",\r\n      \"cantidadRacks\",\r\n      \"cantidadBultos\",\r\n      \"cantidadPallets\",\r\n      \"requisitosEspeciales\",\r\n    ];\r\n\r\n    const remitoUpdateData = {};\r\n    const mercaderiaUpdateData = {};\r\n\r\n    // Separar los datos del body para cada modelo\r\n    for (const key in data) {\r\n      if (remitoFields.includes(key)) {\r\n        remitoUpdateData[key] = data[key];\r\n      }\r\n      if (mercaderiaFields.includes(key)) {\r\n        mercaderiaUpdateData[key] = data[key];\r\n      }\r\n    }\r\n\r\n    console.log(\"Datos para actualizar Remito:\", remitoUpdateData);\r\n    await remito.update(remitoUpdateData);\r\n\r\n    // Si hay mercadería asociada, actualizarla con sus datos\r\n    if (remito.mercaderiaId) {\r\n      const mercaderia = await Mercaderia.findByPk(remito.mercaderiaId);\r\n      if (mercaderia) {\r\n        console.log(\"Datos para actualizar Mercaderia:\", mercaderiaUpdateData);\r\n        await mercaderia.update(mercaderiaUpdateData);\r\n        console.log(\"Mercadería actualizada exitosamente.\");\r\n      } else {\r\n        console.log(\r\n          \"Error: Mercadería asociada no encontrada con ID:\",\r\n          remito.mercaderiaId\r\n        );\r\n      }\r\n    } else {\r\n      console.log(\"Info: El remito no tiene ID de mercadería asociada.\");\r\n    }\r\n\r\n    // Devolver el remito completo y actualizado con todas sus relaciones\r\n    const remitoActualizado = await Remito.findByPk(id, {\r\n      include: [\"cliente\", \"destino\", \"estado\", \"mercaderia\"],\r\n    });\r\n\r\n    console.log(\"--- Finalizando actualización de Remito ---\");\r\n    res.status(200).json(remitoActualizado);\r\n  } catch (error) {\r\n    console.error(`Error al actualizar remito con ID ${id}:`, error);\r\n    res.status(500).json({ message: \"Error al actualizar el remito\" });\r\n  }\r\n};\r\ncontroller.updateRemito = updateRemito;\r\n\r\nconst updateEstadoRemito = async (req, res) => {\r\n  const remitoId = req.params.id;\r\n  const estId = req.params.eid;\r\n  const remito = await Remito.findByPk(remitoId);\r\n  await remito.update({ estadoId: estId });\r\n  const remitoActualizado = await Remito.findByPk(remitoId, {\r\n    include: [\r\n      {\r\n        model: Cliente,\r\n        as: \"cliente\",\r\n      },\r\n      {\r\n        model: Destino,\r\n        as: \"destino\",\r\n      },\r\n      {\r\n        model: Estado,\r\n        as: \"estado\",\r\n      },\r\n    ],\r\n  });\r\n  res.status(200).json(remitoActualizado);\r\n};\r\ncontroller.updateEstadoRemito = updateEstadoRemito;\r\n\r\nconst deleteRemito = async (req, res) => {\r\n  const id = req.params.id;\r\n  const remito = await Remito.findByPk(id);\r\n  await remito.destroy();\r\n  res.status(200).json({ message: \"Remito eliminado correctamente\" });\r\n};\r\ncontroller.deleteRemito = deleteRemito;\r\n\r\n// Reporte: Volumen total de mercadería por cliente/período\r\nconst getVolumenPorClientePeriodo = async (req, res) => {\r\n  const { clienteId, fechaDesde, fechaHasta } = req.query;\r\n  const { Remito, Mercaderia, Cliente } = require(\"../models\");\r\n  try {\r\n    const where = {};\r\n    if (clienteId) where.clienteId = clienteId;\r\n    if (fechaDesde && fechaHasta) {\r\n      where.fechaEmision = { $between: [fechaDesde, fechaHasta] };\r\n    } else if (fechaDesde) {\r\n      where.fechaEmision = { $gte: fechaDesde };\r\n    } else if (fechaHasta) {\r\n      where.fechaEmision = { $lte: fechaHasta };\r\n    }\r\n    const remitos = await Remito.findAll({\r\n      where,\r\n      include: [\r\n        { model: Mercaderia, as: \"mercaderia\" },\r\n        { model: Cliente, as: \"cliente\" },\r\n      ],\r\n    });\r\n    // Agrupar por cliente\r\n    const resultado = {};\r\n    remitos.forEach((remito) => {\r\n      const cliente = remito.cliente;\r\n      const razonSocial = cliente ? cliente.razonSocial : \"Sin cliente\";\r\n      const volumen = remito.mercaderia\r\n        ? remito.mercaderia.volumenMetrosCubico\r\n        : 0;\r\n      if (!resultado[razonSocial]) {\r\n        resultado[razonSocial] = 0;\r\n      }\r\n      resultado[razonSocial] += volumen;\r\n    });\r\n    // Formatear para frontend\r\n    const data = Object.entries(resultado).map(([cliente, volumenTotal]) => ({\r\n      cliente,\r\n      volumenTotal,\r\n    }));\r\n    res.json(data);\r\n  } catch (error) {\r\n    console.error(error);\r\n    res\r\n      .status(500)\r\n      .json({\r\n        error: \"Error al obtener el reporte de volumen por cliente/período\",\r\n      });\r\n  }\r\n};\r\ncontroller.getVolumenPorClientePeriodo = getVolumenPorClientePeriodo;\r\n\r\nmodule.exports = controller;\r\n"],"file":"remitoController.js"}