{"version":3,"sources":["../../../lib/controllers/remitoController.js"],"names":["includes","require","Remito","Cliente","Destino","Contacto","Estado","Mercaderia","sequelize","message","Op","controller","getRemitos","req","res","page","parseInt","query","limit","offset","where","numeroAsignado","iLike","clienteId","destinoId","estadoId","prioridad","fechaEmision","year","month","day","split","map","Number","fechaInicio","Date","fechaFin","gte","lte","count","rows","findAndCountAll","include","model","as","order","status","json","data","totalItems","totalPages","Math","ceil","currentPage","error","console","getRemitoById","id","params","remito","findByPk","createRemito","tipoMercaderia","valorDeclarado","volumenMetrosCubico","pesoMercaderia","cantidadBobinas","cantidadRacks","cantidadBultos","cantidadPallets","requisitosEspeciales","observaciones","razonNoEntrega","body","archivoEnviado","file","path","create","archivoAdjunto","createRemitoWithClienteAndDestino","t","transaction","convertToInteger","value","undefined","numValue","parseFloat","isNaN","floor","mercaderiaData","nuevaMercaderia","nuevoRemito","mercaderiaId","commit","remitoCompleto","rollback","updateRemito","log","remitoFields","mercaderiaFields","remitoUpdateData","mercaderiaUpdateData","key","update","mercaderia","mercaderiaUpdateDataProcessed","remitoActualizado","updateEstadoRemito","remitoId","estId","eid","deleteRemito","destroy","getVolumenPorClientePeriodo","fechaDesde","fechaHasta","$between","$gte","$lte","remitos","findAll","resultado","forEach","cliente","razonSocial","volumen","Object","entries","volumenTotal","module","exports"],"mappings":"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","sourcesContent":["const { includes } = require(\"lodash\");\nconst {\n  Remito,\n  Cliente,\n  Destino,\n  Contacto,\n  Estado,\n  Mercaderia,\n  sequelize,\n} = require(\"../models\");\nconst { message } = require(\"../schemas/estadoSchema\");\nconst { Op } = require(\"sequelize\");\nconst controller = {};\n\nconst getRemitos = async (req, res) => {\n  try {\n    const page = parseInt(req.query.page, 10) || 1;\n    const limit = parseInt(req.query.limit, 10) || 20;\n    const offset = (page - 1) * limit;\n\n    // Filtros\n    const where = {};\n    if (req.query.numeroAsignado) {\n      where.numeroAsignado = { [Op.iLike]: `%${req.query.numeroAsignado}%` };\n    }\n    if (req.query.clienteId) {\n      where.clienteId = req.query.clienteId;\n    }\n    if (req.query.destinoId) {\n      where.destinoId = req.query.destinoId;\n    }\n    if (req.query.estadoId) {\n      where.estadoId = req.query.estadoId;\n    }\n    if (req.query.prioridad) {\n      where.prioridad = req.query.prioridad;\n    }\n    if (req.query.fechaEmision) {\n      // Buscar por fecha específica (formato YYYY-MM-DD)\n      const [year, month, day] = req.query.fechaEmision.split(\"-\").map(Number);\n      const fechaInicio = new Date(year, month - 1, day, 0, 0, 0, 0);\n      const fechaFin = new Date(year, month - 1, day, 23, 59, 59, 999);\n\n      where.fechaEmision = {\n        [Op.gte]: fechaInicio,\n        [Op.lte]: fechaFin,\n      };\n    }\n\n    const { count, rows } = await Remito.findAndCountAll({\n      where,\n      limit,\n      offset,\n      include: [\n        {\n          model: Destino,\n          as: \"destino\",\n        },\n        {\n          model: Cliente,\n          as: \"cliente\",\n        },\n        {\n          model: Estado,\n          as: \"estado\",\n        },\n      ],\n      order: [[\"createdAt\", \"DESC\"]],\n    });\n\n    res.status(200).json({\n      data: rows,\n      totalItems: count,\n      totalPages: Math.ceil(count / limit),\n      currentPage: page,\n    });\n  } catch (error) {\n    console.error(\"Error al obtener remitos:\", error);\n    res.status(500).json({ message: \"Error al obtener los remitos\" });\n  }\n};\ncontroller.getRemitos = getRemitos;\n\nconst getRemitoById = async (req, res) => {\n  const id = req.params.id;\n  const remito = await Remito.findByPk(id, {\n    include: [\n      {\n        model: Destino,\n        as: \"destino\",\n      },\n      {\n        model: Cliente,\n        as: \"cliente\",\n      },\n      {\n        model: Estado,\n        as: \"estado\",\n      },\n      {\n        model: Mercaderia,\n        as: \"mercaderia\",\n      },\n    ],\n  });\n  res.status(200).json(remito);\n};\ncontroller.getRemitoById = getRemitoById;\n\nconst createRemito = async (req, res) => {\n  const {\n    numeroAsignado,\n    tipoMercaderia,\n    valorDeclarado,\n    volumenMetrosCubico,\n    pesoMercaderia,\n    cantidadBobinas,\n    cantidadRacks,\n    cantidadBultos,\n    cantidadPallets,\n    requisitosEspeciales,\n    observaciones,\n    razonNoEntrega,\n  } = req.body;\n  const fechaEmision = new Date();\n  const archivoEnviado = req.file?.path || null;\n  const remito = await Remito.create({\n    numeroAsignado,\n    tipoMercaderia,\n    valorDeclarado,\n    volumenMetrosCubico,\n    pesoMercaderia,\n    fechaEmision,\n    cantidadBobinas,\n    cantidadRacks,\n    cantidadBultos,\n    cantidadPallets,\n    requisitosEspeciales,\n    observaciones,\n    archivoAdjunto: archivoEnviado,\n    razonNoEntrega,\n  });\n  res.status(201).json(remito);\n};\ncontroller.createRemito = createRemito;\n\nconst createRemitoWithClienteAndDestino = async (req, res) => {\n  const t = await sequelize.transaction(); // Iniciar transacción\n\n  try {\n    const {\n      numeroAsignado,\n      fechaEmision,\n      observaciones,\n      clienteId,\n      destinoId,\n      prioridad,\n      tipoMercaderia,\n      valorDeclarado,\n      volumenMetrosCubico,\n      pesoMercaderia,\n      cantidadBobinas,\n      cantidadRacks,\n      cantidadBultos,\n      cantidadPallets,\n      requisitosEspeciales,\n    } = req.body;\n\n    // Función para convertir valores a enteros para campos BIGINT\n    const convertToInteger = (value) => {\n      if (value === null || value === undefined || value === \"\") return null;\n      const numValue = parseFloat(value);\n      return isNaN(numValue) ? null : Math.floor(numValue);\n    };\n\n    // Convertir valores numéricos a enteros\n    const mercaderiaData = {\n      tipoMercaderia,\n      valorDeclarado: convertToInteger(valorDeclarado),\n      volumenMetrosCubico: convertToInteger(volumenMetrosCubico),\n      pesoMercaderia: convertToInteger(pesoMercaderia),\n      cantidadBobinas: convertToInteger(cantidadBobinas),\n      cantidadRacks: convertToInteger(cantidadRacks),\n      cantidadBultos: convertToInteger(cantidadBultos),\n      cantidadPallets: convertToInteger(cantidadPallets),\n      requisitosEspeciales,\n    };\n\n    // 1. Crear Mercaderia dentro de la transacción\n    const nuevaMercaderia = await Mercaderia.create(mercaderiaData, {\n      transaction: t,\n    });\n\n    // 2. Crear Remito dentro de la transacción\n    const nuevoRemito = await Remito.create(\n      {\n        numeroAsignado,\n        fechaEmision,\n        observaciones,\n        prioridad,\n        clienteId,\n        destinoId,\n        mercaderiaId: nuevaMercaderia.id,\n        estadoId: 1,\n        archivoAdjunto: req.file?.path || null,\n        razonNoEntrega: req.body.razonNoEntrega,\n      },\n      { transaction: t }\n    );\n\n    // Si todo va bien, confirmar la transacción\n    await t.commit();\n\n    // Devolver el remito completo con sus relaciones\n    const remitoCompleto = await Remito.findByPk(nuevoRemito.id, {\n      include: [\"cliente\", \"destino\", \"estado\", \"mercaderia\"],\n    });\n\n    res.status(201).json(remitoCompleto);\n  } catch (error) {\n    // Si algo falla, revertir la transacción\n    await t.rollback();\n    console.error(\n      \"Error al crear remito con mercaderia (transacción revertida):\",\n      error\n    );\n    res.status(500).json({ message: \"Error al crear el remito\" });\n  }\n};\ncontroller.createRemitoWithClienteAndDestino = createRemitoWithClienteAndDestino;\n\nconst updateRemito = async (req, res) => {\n  const { id } = req.params;\n  const data = req.body;\n\n  console.log(\"--- Iniciando actualización de Remito ---\");\n  console.log(\"ID del Remito:\", id);\n  console.log(\"Datos recibidos (req.body):\", data);\n\n  try {\n    const remito = await Remito.findByPk(id);\n    if (!remito) {\n      console.log(\"Error: Remito no encontrado.\");\n      return res.status(404).json({ message: \"Remito no encontrado\" });\n    }\n\n    console.log(\n      \"Remito encontrado. ID de mercadería asociada:\",\n      remito.mercaderiaId\n    );\n\n    // Definir los campos que pertenecen a cada modelo\n    const remitoFields = [\n      \"numeroAsignado\",\n      \"fechaEmision\",\n      \"observaciones\",\n      \"prioridad\",\n      \"clienteId\",\n      \"destinoId\",\n      \"estadoId\",\n      \"razonNoEntrega\",\n    ];\n    const mercaderiaFields = [\n      \"tipoMercaderia\",\n      \"valorDeclarado\",\n      \"volumenMetrosCubico\",\n      \"pesoMercaderia\",\n      \"cantidadBobinas\",\n      \"cantidadRacks\",\n      \"cantidadBultos\",\n      \"cantidadPallets\",\n      \"requisitosEspeciales\",\n    ];\n\n    const remitoUpdateData = {};\n    const mercaderiaUpdateData = {};\n\n    // Separar los datos del body para cada modelo\n    for (const key in data) {\n      if (remitoFields.includes(key)) {\n        remitoUpdateData[key] = data[key];\n      }\n      if (mercaderiaFields.includes(key)) {\n        mercaderiaUpdateData[key] = data[key];\n      }\n    }\n\n    console.log(\"Datos para actualizar Remito:\", remitoUpdateData);\n    await remito.update(remitoUpdateData);\n\n    // Si hay mercadería asociada, actualizarla con sus datos\n    if (remito.mercaderiaId) {\n      const mercaderia = await Mercaderia.findByPk(remito.mercaderiaId);\n      if (mercaderia) {\n        // Función para convertir valores a enteros para campos BIGINT\n        const convertToInteger = (value) => {\n          if (value === null || value === undefined || value === \"\")\n            return null;\n          const numValue = parseFloat(value);\n          return isNaN(numValue) ? null : Math.floor(numValue);\n        };\n\n        // Convertir valores numéricos a enteros\n        const mercaderiaUpdateDataProcessed = {\n          ...mercaderiaUpdateData,\n          valorDeclarado: convertToInteger(mercaderiaUpdateData.valorDeclarado),\n          volumenMetrosCubico: convertToInteger(\n            mercaderiaUpdateData.volumenMetrosCubico\n          ),\n          pesoMercaderia: convertToInteger(mercaderiaUpdateData.pesoMercaderia),\n          cantidadBobinas: convertToInteger(\n            mercaderiaUpdateData.cantidadBobinas\n          ),\n          cantidadRacks: convertToInteger(mercaderiaUpdateData.cantidadRacks),\n          cantidadBultos: convertToInteger(mercaderiaUpdateData.cantidadBultos),\n          cantidadPallets: convertToInteger(\n            mercaderiaUpdateData.cantidadPallets\n          ),\n        };\n\n        console.log(\n          \"Datos para actualizar Mercaderia:\",\n          mercaderiaUpdateDataProcessed\n        );\n        await mercaderia.update(mercaderiaUpdateDataProcessed);\n        console.log(\"Mercadería actualizada exitosamente.\");\n      } else {\n        console.log(\n          \"Error: Mercadería asociada no encontrada con ID:\",\n          remito.mercaderiaId\n        );\n      }\n    } else {\n      console.log(\"Info: El remito no tiene ID de mercadería asociada.\");\n    }\n\n    // Devolver el remito completo y actualizado con todas sus relaciones\n    const remitoActualizado = await Remito.findByPk(id, {\n      include: [\"cliente\", \"destino\", \"estado\", \"mercaderia\"],\n    });\n\n    console.log(\"--- Finalizando actualización de Remito ---\");\n    res.status(200).json(remitoActualizado);\n  } catch (error) {\n    console.error(`Error al actualizar remito con ID ${id}:`, error);\n    res.status(500).json({ message: \"Error al actualizar el remito\" });\n  }\n};\ncontroller.updateRemito = updateRemito;\n\nconst updateEstadoRemito = async (req, res) => {\n  const remitoId = req.params.id;\n  const estId = req.params.eid;\n  const remito = await Remito.findByPk(remitoId);\n  await remito.update({ estadoId: estId });\n  const remitoActualizado = await Remito.findByPk(remitoId, {\n    include: [\n      {\n        model: Cliente,\n        as: \"cliente\",\n      },\n      {\n        model: Destino,\n        as: \"destino\",\n      },\n      {\n        model: Estado,\n        as: \"estado\",\n      },\n    ],\n  });\n  res.status(200).json(remitoActualizado);\n};\ncontroller.updateEstadoRemito = updateEstadoRemito;\n\nconst deleteRemito = async (req, res) => {\n  const id = req.params.id;\n  const remito = await Remito.findByPk(id);\n  await remito.destroy();\n  res.status(200).json({ message: \"Remito eliminado correctamente\" });\n};\ncontroller.deleteRemito = deleteRemito;\n\n// Reporte: Volumen total de mercadería por cliente/período\nconst getVolumenPorClientePeriodo = async (req, res) => {\n  const { clienteId, fechaDesde, fechaHasta } = req.query;\n  const { Remito, Mercaderia, Cliente } = require(\"../models\");\n  try {\n    const where = {};\n    if (clienteId) where.clienteId = clienteId;\n    if (fechaDesde && fechaHasta) {\n      where.fechaEmision = { $between: [fechaDesde, fechaHasta] };\n    } else if (fechaDesde) {\n      where.fechaEmision = { $gte: fechaDesde };\n    } else if (fechaHasta) {\n      where.fechaEmision = { $lte: fechaHasta };\n    }\n    const remitos = await Remito.findAll({\n      where,\n      include: [\n        { model: Mercaderia, as: \"mercaderia\" },\n        { model: Cliente, as: \"cliente\" },\n      ],\n    });\n    // Agrupar por cliente\n    const resultado = {};\n    remitos.forEach((remito) => {\n      const cliente = remito.cliente;\n      const razonSocial = cliente ? cliente.razonSocial : \"Sin cliente\";\n      const volumen = remito.mercaderia\n        ? remito.mercaderia.volumenMetrosCubico\n        : 0;\n      if (!resultado[razonSocial]) {\n        resultado[razonSocial] = 0;\n      }\n      resultado[razonSocial] += volumen;\n    });\n    // Formatear para frontend\n    const data = Object.entries(resultado).map(([cliente, volumenTotal]) => ({\n      cliente,\n      volumenTotal,\n    }));\n    res.json(data);\n  } catch (error) {\n    console.error(error);\n    res.status(500).json({\n      error: \"Error al obtener el reporte de volumen por cliente/período\",\n    });\n  }\n};\ncontroller.getVolumenPorClientePeriodo = getVolumenPorClientePeriodo;\n\nmodule.exports = controller;\n"],"file":"remitoController.js"}