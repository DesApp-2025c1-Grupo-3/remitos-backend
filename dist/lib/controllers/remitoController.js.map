{"version":3,"sources":["../../../lib/controllers/remitoController.js"],"names":["includes","require","Remito","Cliente","Destino","Contacto","Estado","Mercaderia","sequelize","message","Op","controller","getRemitos","req","res","page","parseInt","query","limit","offset","where","numeroAsignado","iLike","clienteId","estadoId","prioridad","fechaEmision","year","month","day","split","map","Number","fechaInicio","Date","fechaFin","gte","lte","count","rows","findAndCountAll","include","model","as","order","status","json","data","totalItems","totalPages","Math","ceil","currentPage","error","console","getRemitoById","id","params","remito","findByPk","createRemito","tipoMercaderia","valorDeclarado","volumenMetrosCubico","pesoMercaderia","cantidadBobinas","cantidadRacks","cantidadBultos","cantidadPallets","requisitosEspeciales","observaciones","body","archivoEnviado","file","path","create","archivoAdjunto","createRemitoWithClienteAndDestino","t","transaction","destinoId","nuevaMercaderia","nuevoRemito","mercaderiaId","filename","commit","remitoCompleto","rollback","updateRemito","log","remitoFields","mercaderiaFields","remitoUpdateData","mercaderiaUpdateData","key","update","mercaderia","remitoActualizado","updateEstadoRemito","remitoId","estId","eid","deleteRemito","destroy","module","exports"],"mappings":"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","sourcesContent":["const { includes } = require(\"lodash\");\r\nconst {\r\n  Remito,\r\n  Cliente,\r\n  Destino,\r\n  Contacto,\r\n  Estado,\r\n  Mercaderia,\r\n  sequelize,\r\n} = require(\"../models\");\r\nconst { message } = require(\"../schemas/estadoSchema\");\r\nconst { Op } = require('sequelize');\r\nconst controller = {};\r\n\r\nconst getRemitos = async (req, res) => {\r\n  try {\r\n    const page = parseInt(req.query.page, 10) || 1;\r\n    const limit = parseInt(req.query.limit, 10) || 20;\r\n    const offset = (page - 1) * limit;\r\n\r\n    // Filtros\r\n    const where = {};\r\n    if (req.query.numeroAsignado) {\r\n      where.numeroAsignado = { [Op.iLike]: `%${req.query.numeroAsignado}%` };\r\n    }\r\n    if (req.query.clienteId) {\r\n      where.clienteId = req.query.clienteId;\r\n    }\r\n    if (req.query.estadoId) {\r\n      where.estadoId = req.query.estadoId;\r\n    }\r\n    if (req.query.prioridad) {\r\n      where.prioridad = req.query.prioridad;\r\n    }\r\n    if (req.query.fechaEmision) {\r\n      // Buscar por fecha específica (formato YYYY-MM-DD)\r\n      const [year, month, day] = req.query.fechaEmision.split('-').map(Number);\r\n      const fechaInicio = new Date(year, month - 1, day, 0, 0, 0, 0);\r\n      const fechaFin = new Date(year, month - 1, day, 23, 59, 59, 999);\r\n      \r\n      where.fechaEmision = {\r\n        [Op.gte]: fechaInicio,\r\n        [Op.lte]: fechaFin\r\n      };\r\n    }\r\n\r\n    const { count, rows } = await Remito.findAndCountAll({\r\n      where,\r\n      limit,\r\n      offset,\r\n      include: [\r\n        {\r\n          model: Destino,\r\n          as: \"destino\",\r\n        },\r\n        {\r\n          model: Cliente,\r\n          as: \"cliente\",\r\n        },\r\n        {\r\n          model: Estado,\r\n          as: \"estado\",\r\n        },\r\n      ],\r\n      order: [[\"createdAt\", \"DESC\"]],\r\n    });\r\n\r\n    res.status(200).json({\r\n      data: rows,\r\n      totalItems: count,\r\n      totalPages: Math.ceil(count / limit),\r\n      currentPage: page,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error al obtener remitos:\", error);\r\n    res.status(500).json({ message: \"Error al obtener los remitos\" });\r\n  }\r\n};\r\ncontroller.getRemitos = getRemitos;\r\n\r\nconst getRemitoById = async (req, res) => {\r\n  const id = req.params.id;\r\n  const remito = await Remito.findByPk(id, {\r\n    include: [\r\n      {\r\n        model: Destino,\r\n        as: \"destino\",\r\n      },\r\n      {\r\n        model: Cliente,\r\n        as: \"cliente\",\r\n      },\r\n      {\r\n        model: Estado,\r\n        as: \"estado\",\r\n      },\r\n      {\r\n        model: Mercaderia,\r\n        as: \"mercaderia\",\r\n      },\r\n    ],\r\n  });\r\n  res.status(200).json(remito);\r\n};\r\ncontroller.getRemitoById = getRemitoById;\r\n\r\nconst createRemito = async (req, res) => {\r\n  const {\r\n    numeroAsignado,\r\n    tipoMercaderia,\r\n    valorDeclarado,\r\n    volumenMetrosCubico,\r\n    pesoMercaderia,\r\n    cantidadBobinas,\r\n    cantidadRacks,\r\n    cantidadBultos,\r\n    cantidadPallets,\r\n    requisitosEspeciales,\r\n    observaciones,\r\n  } = req.body;\r\n  const fechaEmision = new Date();\r\n  const archivoEnviado = req.file?.path || null;\r\n  const remito = await Remito.create({\r\n    numeroAsignado,\r\n    tipoMercaderia,\r\n    valorDeclarado,\r\n    volumenMetrosCubico,\r\n    pesoMercaderia,\r\n    fechaEmision,\r\n    cantidadBobinas,\r\n    cantidadRacks,\r\n    cantidadBultos,\r\n    cantidadPallets,\r\n    requisitosEspeciales,\r\n    observaciones,\r\n    archivoAdjunto: archivoEnviado,\r\n  });\r\n  res.status(201).json(remito);\r\n};\r\ncontroller.createRemito = createRemito;\r\n\r\nconst createRemitoWithClienteAndDestino = async (req, res) => {\r\n  const t = await sequelize.transaction(); // Iniciar transacción\r\n\r\n  try {\r\n    const {\r\n      numeroAsignado,\r\n      fechaEmision,\r\n      observaciones,\r\n      clienteId,\r\n      destinoId,\r\n      prioridad,\r\n      tipoMercaderia,\r\n      valorDeclarado,\r\n      volumenMetrosCubico,\r\n      pesoMercaderia,\r\n      cantidadBobinas,\r\n      cantidadRacks,\r\n      cantidadBultos,\r\n      cantidadPallets,\r\n      requisitosEspeciales,\r\n    } = req.body;\r\n\r\n    // 1. Crear Mercaderia dentro de la transacción\r\n    const nuevaMercaderia = await Mercaderia.create(\r\n      {\r\n        tipoMercaderia,\r\n        valorDeclarado,\r\n        volumenMetrosCubico,\r\n        pesoMercaderia,\r\n        cantidadBobinas,\r\n        cantidadRacks,\r\n        cantidadBultos,\r\n        cantidadPallets,\r\n        requisitosEspeciales,\r\n      },\r\n      { transaction: t }\r\n    );\r\n\r\n    // 2. Crear Remito dentro de la transacción\r\n    const nuevoRemito = await Remito.create(\r\n      {\r\n        numeroAsignado,\r\n        fechaEmision,\r\n        observaciones,\r\n        prioridad,\r\n        clienteId,\r\n        destinoId,\r\n        mercaderiaId: nuevaMercaderia.id,\r\n        estadoId: 1,\r\n        archivoAdjunto: req.file\r\n          ? `/uploads/remitos/${req.file.filename}`\r\n          : null,\r\n      },\r\n      { transaction: t }\r\n    );\r\n\r\n    // Si todo va bien, confirmar la transacción\r\n    await t.commit();\r\n\r\n    // Devolver el remito completo con sus relaciones\r\n    const remitoCompleto = await Remito.findByPk(nuevoRemito.id, {\r\n      include: [\"cliente\", \"destino\", \"estado\", \"mercaderia\"],\r\n    });\r\n\r\n    res.status(201).json(remitoCompleto);\r\n  } catch (error) {\r\n    // Si algo falla, revertir la transacción\r\n    await t.rollback();\r\n    console.error(\r\n      \"Error al crear remito con mercaderia (transacción revertida):\",\r\n      error\r\n    );\r\n    res.status(500).json({ message: \"Error al crear el remito\" });\r\n  }\r\n};\r\ncontroller.createRemitoWithClienteAndDestino = createRemitoWithClienteAndDestino;\r\n\r\nconst updateRemito = async (req, res) => {\r\n  const { id } = req.params;\r\n  const data = req.body;\r\n\r\n  console.log(\"--- Iniciando actualización de Remito ---\");\r\n  console.log(\"ID del Remito:\", id);\r\n  console.log(\"Datos recibidos (req.body):\", data);\r\n\r\n  try {\r\n    const remito = await Remito.findByPk(id);\r\n    if (!remito) {\r\n      console.log(\"Error: Remito no encontrado.\");\r\n      return res.status(404).json({ message: \"Remito no encontrado\" });\r\n    }\r\n\r\n    console.log(\r\n      \"Remito encontrado. ID de mercadería asociada:\",\r\n      remito.mercaderiaId\r\n    );\r\n\r\n    // Definir los campos que pertenecen a cada modelo\r\n    const remitoFields = [\r\n      \"numeroAsignado\",\r\n      \"fechaEmision\",\r\n      \"observaciones\",\r\n      \"prioridad\",\r\n      \"clienteId\",\r\n      \"destinoId\",\r\n      \"estadoId\",\r\n    ];\r\n    const mercaderiaFields = [\r\n      \"tipoMercaderia\",\r\n      \"valorDeclarado\",\r\n      \"volumenMetrosCubico\",\r\n      \"pesoMercaderia\",\r\n      \"cantidadBobinas\",\r\n      \"cantidadRacks\",\r\n      \"cantidadBultos\",\r\n      \"cantidadPallets\",\r\n      \"requisitosEspeciales\",\r\n    ];\r\n\r\n    const remitoUpdateData = {};\r\n    const mercaderiaUpdateData = {};\r\n\r\n    // Separar los datos del body para cada modelo\r\n    for (const key in data) {\r\n      if (remitoFields.includes(key)) {\r\n        remitoUpdateData[key] = data[key];\r\n      }\r\n      if (mercaderiaFields.includes(key)) {\r\n        mercaderiaUpdateData[key] = data[key];\r\n      }\r\n    }\r\n\r\n    console.log(\"Datos para actualizar Remito:\", remitoUpdateData);\r\n    await remito.update(remitoUpdateData);\r\n\r\n    // Si hay mercadería asociada, actualizarla con sus datos\r\n    if (remito.mercaderiaId) {\r\n      const mercaderia = await Mercaderia.findByPk(remito.mercaderiaId);\r\n      if (mercaderia) {\r\n        console.log(\"Datos para actualizar Mercaderia:\", mercaderiaUpdateData);\r\n        await mercaderia.update(mercaderiaUpdateData);\r\n        console.log(\"Mercadería actualizada exitosamente.\");\r\n      } else {\r\n        console.log(\r\n          \"Error: Mercadería asociada no encontrada con ID:\",\r\n          remito.mercaderiaId\r\n        );\r\n      }\r\n    } else {\r\n      console.log(\"Info: El remito no tiene ID de mercadería asociada.\");\r\n    }\r\n\r\n    // Devolver el remito completo y actualizado con todas sus relaciones\r\n    const remitoActualizado = await Remito.findByPk(id, {\r\n      include: [\"cliente\", \"destino\", \"estado\", \"mercaderia\"],\r\n    });\r\n\r\n    console.log(\"--- Finalizando actualización de Remito ---\");\r\n    res.status(200).json(remitoActualizado);\r\n  } catch (error) {\r\n    console.error(`Error al actualizar remito con ID ${id}:`, error);\r\n    res.status(500).json({ message: \"Error al actualizar el remito\" });\r\n  }\r\n};\r\ncontroller.updateRemito = updateRemito;\r\n\r\nconst updateEstadoRemito = async (req, res) => {\r\n  const remitoId = req.params.id;\r\n  const estId = req.params.eid;\r\n  const remito = await Remito.findByPk(remitoId);\r\n  await remito.update({ estadoId: estId });\r\n  const remitoActualizado = await Remito.findByPk(remitoId, {\r\n    include: [\r\n      {\r\n        model: Cliente,\r\n        as: \"cliente\",\r\n      },\r\n      {\r\n        model: Destino,\r\n        as: \"destino\",\r\n      },\r\n      {\r\n        model: Estado,\r\n        as: \"estado\",\r\n      },\r\n    ],\r\n  });\r\n  res.status(200).json(remitoActualizado);\r\n};\r\ncontroller.updateEstadoRemito = updateEstadoRemito;\r\n\r\nconst deleteRemito = async (req, res) => {\r\n  const id = req.params.id;\r\n  const remito = await Remito.findByPk(id);\r\n  await remito.destroy();\r\n  res.status(200).json({ message: \"Remito eliminado correctamente\" });\r\n};\r\ncontroller.deleteRemito = deleteRemito;\r\n\r\nmodule.exports = controller;\r\n"],"file":"remitoController.js"}