{"version":3,"sources":["../../../lib/controllers/remitoController.js"],"names":["includes","require","Remito","Cliente","Destino","Contacto","Estado","Mercaderia","TipoMercaderia","sequelize","message","Op","controller","getRemitos","req","res","page","parseInt","query","limit","offset","where","numeroAsignado","iLike","clienteId","estadoId","prioridad","fechaEmision","year","month","day","split","map","Number","fechaInicio","Date","fechaFin","gte","lte","count","rows","findAndCountAll","include","model","as","order","status","json","data","totalItems","totalPages","Math","ceil","currentPage","error","console","getRemitoById","id","params","remito","findByPk","createRemito","tipoMercaderiaId","valorDeclarado","volumenMetrosCubico","pesoMercaderia","cantidadBobinas","cantidadRacks","cantidadBultos","cantidadPallets","requisitosEspeciales","observaciones","body","archivoEnviado","file","path","tipoMercaderia","nuevaMercaderia","create","destinoId","mercaderiaId","archivoAdjunto","createRemitoWithClienteAndDestino","t","transaction","nuevoRemito","filename","commit","remitoCompleto","rollback","updateRemito","log","remitoFields","mercaderiaFields","remitoUpdateData","mercaderiaUpdateData","key","update","mercaderia","remitoActualizado","updateEstadoRemito","remitoId","estId","eid","deleteRemito","destroy","getVolumenPorClientePeriodo","fechaDesde","fechaHasta","$between","$gte","$lte","remitos","findAll","resultado","forEach","cliente","razonSocial","volumen","Object","entries","volumenTotal","module","exports"],"mappings":"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","sourcesContent":["const { includes } = require(\"lodash\");\r\nconst {\r\n  Remito,\r\n  Cliente,\r\n  Destino,\r\n  Contacto,\r\n  Estado,\r\n  Mercaderia,\r\n  TipoMercaderia,\r\n  sequelize,\r\n} = require(\"../models\");\r\nconst { message } = require(\"../schemas/estadoSchema\");\r\nconst { Op } = require(\"sequelize\");\r\nconst controller = {};\r\n\r\nconst getRemitos = async (req, res) => {\r\n  try {\r\n    const page = parseInt(req.query.page, 10) || 1;\r\n    const limit = parseInt(req.query.limit, 10) || 20;\r\n    const offset = (page - 1) * limit;\r\n\r\n    // Filtros\r\n    const where = {};\r\n    if (req.query.numeroAsignado) {\r\n      where.numeroAsignado = { [Op.iLike]: `%${req.query.numeroAsignado}%` };\r\n    }\r\n    if (req.query.clienteId) {\r\n      where.clienteId = req.query.clienteId;\r\n    }\r\n    if (req.query.estadoId) {\r\n      where.estadoId = req.query.estadoId;\r\n    }\r\n    if (req.query.prioridad) {\r\n      where.prioridad = req.query.prioridad;\r\n    }\r\n    if (req.query.fechaEmision) {\r\n      // Buscar por fecha específica (formato YYYY-MM-DD)\r\n      const [year, month, day] = req.query.fechaEmision.split(\"-\").map(Number);\r\n      const fechaInicio = new Date(year, month - 1, day, 0, 0, 0, 0);\r\n      const fechaFin = new Date(year, month - 1, day, 23, 59, 59, 999);\r\n\r\n      where.fechaEmision = {\r\n        [Op.gte]: fechaInicio,\r\n        [Op.lte]: fechaFin,\r\n      };\r\n    }\r\n\r\n    const { count, rows } = await Remito.findAndCountAll({\r\n      where,\r\n      limit,\r\n      offset,\r\n      include: [\r\n        {\r\n          model: Destino,\r\n          as: \"destino\",\r\n        },\r\n        {\r\n          model: Cliente,\r\n          as: \"cliente\",\r\n        },\r\n        {\r\n          model: Estado,\r\n          as: \"estado\",\r\n        },\r\n        {\r\n          model: Mercaderia,\r\n          as: \"mercaderia\",\r\n          include: [{ model: TipoMercaderia, as: \"tipoMercaderia\" }],\r\n        },\r\n      ],\r\n      order: [[\"createdAt\", \"DESC\"]],\r\n    });\r\n\r\n    res.status(200).json({\r\n      data: rows,\r\n      totalItems: count,\r\n      totalPages: Math.ceil(count / limit),\r\n      currentPage: page,\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error al obtener remitos:\", error);\r\n    res.status(500).json({ message: \"Error al obtener los remitos\" });\r\n  }\r\n};\r\ncontroller.getRemitos = getRemitos;\r\n\r\nconst getRemitoById = async (req, res) => {\r\n  const id = req.params.id;\r\n  const remito = await Remito.findByPk(id, {\r\n    include: [\r\n      {\r\n        model: Destino,\r\n        as: \"destino\",\r\n      },\r\n      {\r\n        model: Cliente,\r\n        as: \"cliente\",\r\n      },\r\n      {\r\n        model: Estado,\r\n        as: \"estado\",\r\n      },\r\n      {\r\n        model: Mercaderia,\r\n        as: \"mercaderia\",\r\n        include: [{ model: TipoMercaderia, as: \"tipoMercaderia\" }],\r\n      },\r\n    ],\r\n  });\r\n  res.status(200).json(remito);\r\n};\r\ncontroller.getRemitoById = getRemitoById;\r\n\r\nconst createRemito = async (req, res) => {\r\n  const {\r\n    numeroAsignado,\r\n    tipoMercaderiaId,\r\n    valorDeclarado,\r\n    volumenMetrosCubico,\r\n    pesoMercaderia,\r\n    cantidadBobinas,\r\n    cantidadRacks,\r\n    cantidadBultos,\r\n    cantidadPallets,\r\n    requisitosEspeciales,\r\n    observaciones,\r\n  } = req.body;\r\n  const fechaEmision = new Date();\r\n  const archivoEnviado = req.file?.path || null;\r\n\r\n  try {\r\n    const tipoMercaderia = await TipoMercaderia.findByPk(tipoMercaderiaId);\r\n    if (!tipoMercaderia) {\r\n      return res.status(400).json({ message: \"Tipo de mercadería no encontrado\" });\r\n    }\r\n\r\n    const nuevaMercaderia = await Mercaderia.create({\r\n      tipoMercaderiaId,\r\n      valorDeclarado,\r\n      volumenMetrosCubico,\r\n      pesoMercaderia,\r\n      cantidadBobinas,\r\n      cantidadRacks,\r\n      cantidadBultos,\r\n      cantidadPallets,\r\n      requisitosEspeciales,\r\n    });\r\n\r\n    const remito = await Remito.create({\r\n      numeroAsignado,\r\n      fechaEmision,\r\n      observaciones,\r\n      prioridad: 1, // Default priority\r\n      clienteId: 1, // Default client (assuming client 1 exists)\r\n      destinoId: 1, // Default destination (assuming destination 1 exists)\r\n      mercaderiaId: nuevaMercaderia.id,\r\n      estadoId: 1, // Default state (assuming state 1 exists)\r\n      archivoAdjunto: archivoEnviado,\r\n    });\r\n\r\n    res.status(201).json(remito);\r\n  } catch (error) {\r\n    console.error(\"Error al crear remito:\", error);\r\n    res.status(500).json({ message: \"Error al crear el remito\" });\r\n  }\r\n};\r\ncontroller.createRemito = createRemito;\r\n\r\nconst createRemitoWithClienteAndDestino = async (req, res) => {\r\n  const t = await sequelize.transaction(); // Iniciar transacción\r\n\r\n  try {\r\n    const {\r\n      numeroAsignado,\r\n      fechaEmision,\r\n      observaciones,\r\n      clienteId,\r\n      destinoId,\r\n      prioridad,\r\n      tipoMercaderiaId,\r\n      valorDeclarado,\r\n      volumenMetrosCubico,\r\n      pesoMercaderia,\r\n      cantidadBobinas,\r\n      cantidadRacks,\r\n      cantidadBultos,\r\n      cantidadPallets,\r\n      requisitosEspeciales,\r\n    } = req.body;\r\n\r\n    const tipoMercaderia = await TipoMercaderia.findByPk(tipoMercaderiaId);\r\n    if (!tipoMercaderia) {\r\n      return res.status(400).json({ message: \"Tipo de mercadería no encontrado\" });\r\n    }\r\n\r\n    // 1. Crear Mercaderia dentro de la transacción\r\n    const nuevaMercaderia = await Mercaderia.create(\r\n      {\r\n        tipoMercaderiaId,\r\n        valorDeclarado,\r\n        volumenMetrosCubico,\r\n        pesoMercaderia,\r\n        cantidadBobinas,\r\n        cantidadRacks,\r\n        cantidadBultos,\r\n        cantidadPallets,\r\n        requisitosEspeciales,\r\n      },\r\n      { transaction: t }\r\n    );\r\n\r\n    // 2. Crear Remito dentro de la transacción\r\n    const nuevoRemito = await Remito.create(\r\n      {\r\n        numeroAsignado,\r\n        fechaEmision,\r\n        observaciones,\r\n        prioridad,\r\n        clienteId,\r\n        destinoId,\r\n        mercaderiaId: nuevaMercaderia.id,\r\n        estadoId: 1,\r\n        archivoAdjunto: req.file\r\n          ? `/uploads/remitos/${req.file.filename}`\r\n          : null,\r\n      },\r\n      { transaction: t }\r\n    );\r\n\r\n    // Si todo va bien, confirmar la transacción\r\n    await t.commit();\r\n\r\n    // Devolver el remito completo con sus relaciones\r\n    const remitoCompleto = await Remito.findByPk(nuevoRemito.id, {\r\n      include: [\"cliente\", \"destino\", \"estado\", \"mercaderia\"],\r\n    });\r\n\r\n    res.status(201).json(remitoCompleto);\r\n  } catch (error) {\r\n    // Si algo falla, revertir la transacción\r\n    await t.rollback();\r\n    console.error(\r\n      \"Error al crear remito con mercaderia (transacción revertida):\",\r\n      error\r\n    );\r\n    res.status(500).json({ message: \"Error al crear el remito\" });\r\n  }\r\n};\r\ncontroller.createRemitoWithClienteAndDestino = createRemitoWithClienteAndDestino;\r\n\r\nconst updateRemito = async (req, res) => {\r\n  const { id } = req.params;\r\n  const data = req.body;\r\n\r\n  console.log(\"--- Iniciando actualización de Remito ---\");\r\n  console.log(\"ID del Remito:\", id);\r\n  console.log(\"Datos recibidos (req.body):\", data);\r\n\r\n  try {\r\n    const remito = await Remito.findByPk(id);\r\n    if (!remito) {\r\n      console.log(\"Error: Remito no encontrado.\");\r\n      return res.status(404).json({ message: \"Remito no encontrado\" });\r\n    }\r\n\r\n    console.log(\r\n      \"Remito encontrado. ID de mercadería asociada:\",\r\n      remito.mercaderiaId\r\n    );\r\n\r\n    // Definir los campos que pertenecen a cada modelo\r\n    const remitoFields = [\r\n      \"numeroAsignado\",\r\n      \"fechaEmision\",\r\n      \"observaciones\",\r\n      \"prioridad\",\r\n      \"clienteId\",\r\n      \"destinoId\",\r\n      \"estadoId\",\r\n    ];\r\n    const mercaderiaFields = [\r\n      \"tipoMercaderiaId\",\r\n      \"valorDeclarado\",\r\n      \"volumenMetrosCubico\",\r\n      \"pesoMercaderia\",\r\n      \"cantidadBobinas\",\r\n      \"cantidadRacks\",\r\n      \"cantidadBultos\",\r\n      \"cantidadPallets\",\r\n      \"requisitosEspeciales\",\r\n    ];\r\n\r\n    const remitoUpdateData = {};\r\n    const mercaderiaUpdateData = {};\r\n\r\n    // Separar los datos del body para cada modelo\r\n    for (const key in data) {\r\n      if (remitoFields.includes(key)) {\r\n        remitoUpdateData[key] = data[key];\r\n      }\r\n      if (mercaderiaFields.includes(key)) {\r\n        mercaderiaUpdateData[key] = data[key];\r\n      }\r\n    }\r\n\r\n    console.log(\"Datos para actualizar Remito:\", remitoUpdateData);\r\n    await remito.update(remitoUpdateData);\r\n\r\n    // Si hay mercadería asociada, actualizarla con sus datos\r\n    if (remito.mercaderiaId) {\r\n      const mercaderia = await Mercaderia.findByPk(remito.mercaderiaId);\r\n      if (mercaderia) {\r\n        console.log(\"Datos para actualizar Mercaderia:\", mercaderiaUpdateData);\r\n        await mercaderia.update(mercaderiaUpdateData);\r\n        console.log(\"Mercadería actualizada exitosamente.\");\r\n      } else {\r\n        console.log(\r\n          \"Error: Mercadería asociada no encontrada con ID:\",\r\n          remito.mercaderiaId\r\n        );\r\n      }\r\n    } else {\r\n      console.log(\"Info: El remito no tiene ID de mercadería asociada.\");\r\n    }\r\n\r\n    // Devolver el remito completo y actualizado con todas sus relaciones\r\n    const remitoActualizado = await Remito.findByPk(id, {\r\n      include: [\"cliente\", \"destino\", \"estado\", \"mercaderia\"],\r\n    });\r\n\r\n    console.log(\"--- Finalizando actualización de Remito ---\");\r\n    res.status(200).json(remitoActualizado);\r\n  } catch (error) {\r\n    console.error(`Error al actualizar remito con ID ${id}:`, error);\r\n    res.status(500).json({ message: \"Error al actualizar el remito\" });\r\n  }\r\n};\r\ncontroller.updateRemito = updateRemito;\r\n\r\nconst updateEstadoRemito = async (req, res) => {\r\n  const remitoId = req.params.id;\r\n  const estId = req.params.eid;\r\n  const remito = await Remito.findByPk(remitoId);\r\n  await remito.update({ estadoId: estId });\r\n  const remitoActualizado = await Remito.findByPk(remitoId, {\r\n    include: [\r\n      {\r\n        model: Cliente,\r\n        as: \"cliente\",\r\n      },\r\n      {\r\n        model: Destino,\r\n        as: \"destino\",\r\n      },\r\n      {\r\n        model: Estado,\r\n        as: \"estado\",\r\n      },\r\n    ],\r\n  });\r\n  res.status(200).json(remitoActualizado);\r\n};\r\ncontroller.updateEstadoRemito = updateEstadoRemito;\r\n\r\nconst deleteRemito = async (req, res) => {\r\n  const id = req.params.id;\r\n  const remito = await Remito.findByPk(id);\r\n  await remito.destroy();\r\n  res.status(200).json({ message: \"Remito eliminado correctamente\" });\r\n};\r\ncontroller.deleteRemito = deleteRemito;\r\n\r\n// Reporte: Volumen total de mercadería por cliente/período\r\nconst getVolumenPorClientePeriodo = async (req, res) => {\r\n  const { clienteId, fechaDesde, fechaHasta } = req.query;\r\n  const { Remito, Mercaderia, Cliente } = require(\"../models\");\r\n  try {\r\n    const where = {};\r\n    if (clienteId) where.clienteId = clienteId;\r\n    if (fechaDesde && fechaHasta) {\r\n      where.fechaEmision = { $between: [fechaDesde, fechaHasta] };\r\n    } else if (fechaDesde) {\r\n      where.fechaEmision = { $gte: fechaDesde };\r\n    } else if (fechaHasta) {\r\n      where.fechaEmision = { $lte: fechaHasta };\r\n    }\r\n    const remitos = await Remito.findAll({\r\n      where,\r\n      include: [\r\n        { model: Mercaderia, as: \"mercaderia\" },\r\n        { model: Cliente, as: \"cliente\" },\r\n      ],\r\n    });\r\n    // Agrupar por cliente\r\n    const resultado = {};\r\n    remitos.forEach((remito) => {\r\n      const cliente = remito.cliente;\r\n      const razonSocial = cliente ? cliente.razonSocial : \"Sin cliente\";\r\n      const volumen = remito.mercaderia\r\n        ? remito.mercaderia.volumenMetrosCubico\r\n        : 0;\r\n      if (!resultado[razonSocial]) {\r\n        resultado[razonSocial] = 0;\r\n      }\r\n      resultado[razonSocial] += volumen;\r\n    });\r\n    // Formatear para frontend\r\n    const data = Object.entries(resultado).map(([cliente, volumenTotal]) => ({\r\n      cliente,\r\n      volumenTotal,\r\n    }));\r\n    res.json(data);\r\n  } catch (error) {\r\n    console.error(error);\r\n    res\r\n      .status(500)\r\n      .json({\r\n        error: \"Error al obtener el reporte de volumen por cliente/período\",\r\n      });\r\n  }\r\n};\r\ncontroller.getVolumenPorClientePeriodo = getVolumenPorClientePeriodo;\r\n\r\nmodule.exports = controller;\r\n"],"file":"remitoController.js"}