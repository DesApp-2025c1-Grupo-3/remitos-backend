{"version":3,"sources":["../../../lib/controllers/remitoController.js"],"names":["includes","require","Remito","Cliente","Destino","Contacto","Estado","Mercaderia","sequelize","message","Op","controller","getRemitos","req","res","page","parseInt","query","limit","offset","where","numeroAsignado","iLike","clienteId","estadoId","prioridad","fechaEmision","year","month","day","split","map","Number","fechaInicio","Date","fechaFin","gte","lte","count","rows","findAndCountAll","include","model","as","order","status","json","data","totalItems","totalPages","Math","ceil","currentPage","error","console","getRemitoById","id","params","remito","findByPk","createRemito","tipoMercaderia","valorDeclarado","volumenMetrosCubico","pesoMercaderia","cantidadBobinas","cantidadRacks","cantidadBultos","cantidadPallets","requisitosEspeciales","observaciones","body","archivoEnviado","file","path","create","archivoAdjunto","createRemitoWithClienteAndDestino","t","transaction","destinoId","nuevaMercaderia","nuevoRemito","mercaderiaId","filename","commit","remitoCompleto","rollback","updateRemito","log","remitoFields","mercaderiaFields","remitoUpdateData","mercaderiaUpdateData","key","update","mercaderia","remitoActualizado","updateEstadoRemito","remitoId","estId","eid","deleteRemito","destroy","getVolumenPorClientePeriodo","fechaDesde","fechaHasta","$between","$gte","$lte","remitos","findAll","resultado","forEach","cliente","razonSocial","volumen","Object","entries","volumenTotal","module","exports"],"mappings":"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","sourcesContent":["const { includes } = require(\"lodash\");\nconst {\n  Remito,\n  Cliente,\n  Destino,\n  Contacto,\n  Estado,\n  Mercaderia,\n  sequelize,\n} = require(\"../models\");\nconst { message } = require(\"../schemas/estadoSchema\");\nconst { Op } = require(\"sequelize\");\nconst controller = {};\n\nconst getRemitos = async (req, res) => {\n  try {\n    const page = parseInt(req.query.page, 10) || 1;\n    const limit = parseInt(req.query.limit, 10) || 20;\n    const offset = (page - 1) * limit;\n\n    // Filtros\n    const where = {};\n    if (req.query.numeroAsignado) {\n      where.numeroAsignado = { [Op.iLike]: `%${req.query.numeroAsignado}%` };\n    }\n    if (req.query.clienteId) {\n      where.clienteId = req.query.clienteId;\n    }\n    if (req.query.estadoId) {\n      where.estadoId = req.query.estadoId;\n    }\n    if (req.query.prioridad) {\n      where.prioridad = req.query.prioridad;\n    }\n    if (req.query.fechaEmision) {\n      // Buscar por fecha específica (formato YYYY-MM-DD)\n      const [year, month, day] = req.query.fechaEmision.split(\"-\").map(Number);\n      const fechaInicio = new Date(year, month - 1, day, 0, 0, 0, 0);\n      const fechaFin = new Date(year, month - 1, day, 23, 59, 59, 999);\n\n      where.fechaEmision = {\n        [Op.gte]: fechaInicio,\n        [Op.lte]: fechaFin,\n      };\n    }\n\n    const { count, rows } = await Remito.findAndCountAll({\n      where,\n      limit,\n      offset,\n      include: [\n        {\n          model: Destino,\n          as: \"destino\",\n        },\n        {\n          model: Cliente,\n          as: \"cliente\",\n        },\n        {\n          model: Estado,\n          as: \"estado\",\n        },\n      ],\n      order: [[\"createdAt\", \"DESC\"]],\n    });\n\n    res.status(200).json({\n      data: rows,\n      totalItems: count,\n      totalPages: Math.ceil(count / limit),\n      currentPage: page,\n    });\n  } catch (error) {\n    console.error(\"Error al obtener remitos:\", error);\n    res.status(500).json({ message: \"Error al obtener los remitos\" });\n  }\n};\ncontroller.getRemitos = getRemitos;\n\nconst getRemitoById = async (req, res) => {\n  const id = req.params.id;\n  const remito = await Remito.findByPk(id, {\n    include: [\n      {\n        model: Destino,\n        as: \"destino\",\n      },\n      {\n        model: Cliente,\n        as: \"cliente\",\n      },\n      {\n        model: Estado,\n        as: \"estado\",\n      },\n      {\n        model: Mercaderia,\n        as: \"mercaderia\",\n      },\n    ],\n  });\n  res.status(200).json(remito);\n};\ncontroller.getRemitoById = getRemitoById;\n\nconst createRemito = async (req, res) => {\n  const {\n    numeroAsignado,\n    tipoMercaderia,\n    valorDeclarado,\n    volumenMetrosCubico,\n    pesoMercaderia,\n    cantidadBobinas,\n    cantidadRacks,\n    cantidadBultos,\n    cantidadPallets,\n    requisitosEspeciales,\n    observaciones,\n  } = req.body;\n  const fechaEmision = new Date();\n  const archivoEnviado = req.file?.path || null;\n  const remito = await Remito.create({\n    numeroAsignado,\n    tipoMercaderia,\n    valorDeclarado,\n    volumenMetrosCubico,\n    pesoMercaderia,\n    fechaEmision,\n    cantidadBobinas,\n    cantidadRacks,\n    cantidadBultos,\n    cantidadPallets,\n    requisitosEspeciales,\n    observaciones,\n    archivoAdjunto: archivoEnviado,\n  });\n  res.status(201).json(remito);\n};\ncontroller.createRemito = createRemito;\n\nconst createRemitoWithClienteAndDestino = async (req, res) => {\n  const t = await sequelize.transaction(); // Iniciar transacción\n\n  try {\n    const {\n      numeroAsignado,\n      fechaEmision,\n      observaciones,\n      clienteId,\n      destinoId,\n      prioridad,\n      tipoMercaderia,\n      valorDeclarado,\n      volumenMetrosCubico,\n      pesoMercaderia,\n      cantidadBobinas,\n      cantidadRacks,\n      cantidadBultos,\n      cantidadPallets,\n      requisitosEspeciales,\n    } = req.body;\n\n    // 1. Crear Mercaderia dentro de la transacción\n    const nuevaMercaderia = await Mercaderia.create(\n      {\n        tipoMercaderia,\n        valorDeclarado,\n        volumenMetrosCubico,\n        pesoMercaderia,\n        cantidadBobinas,\n        cantidadRacks,\n        cantidadBultos,\n        cantidadPallets,\n        requisitosEspeciales,\n      },\n      { transaction: t }\n    );\n\n    // 2. Crear Remito dentro de la transacción\n    const nuevoRemito = await Remito.create(\n      {\n        numeroAsignado,\n        fechaEmision,\n        observaciones,\n        prioridad,\n        clienteId,\n        destinoId,\n        mercaderiaId: nuevaMercaderia.id,\n        estadoId: 1,\n        archivoAdjunto: req.file\n          ? `/uploads/remitos/${req.file.filename}`\n          : null,\n      },\n      { transaction: t }\n    );\n\n    // Si todo va bien, confirmar la transacción\n    await t.commit();\n\n    // Devolver el remito completo con sus relaciones\n    const remitoCompleto = await Remito.findByPk(nuevoRemito.id, {\n      include: [\"cliente\", \"destino\", \"estado\", \"mercaderia\"],\n    });\n\n    res.status(201).json(remitoCompleto);\n  } catch (error) {\n    // Si algo falla, revertir la transacción\n    await t.rollback();\n    console.error(\n      \"Error al crear remito con mercaderia (transacción revertida):\",\n      error\n    );\n    res.status(500).json({ message: \"Error al crear el remito\" });\n  }\n};\ncontroller.createRemitoWithClienteAndDestino = createRemitoWithClienteAndDestino;\n\nconst updateRemito = async (req, res) => {\n  const { id } = req.params;\n  const data = req.body;\n\n  console.log(\"--- Iniciando actualización de Remito ---\");\n  console.log(\"ID del Remito:\", id);\n  console.log(\"Datos recibidos (req.body):\", data);\n\n  try {\n    const remito = await Remito.findByPk(id);\n    if (!remito) {\n      console.log(\"Error: Remito no encontrado.\");\n      return res.status(404).json({ message: \"Remito no encontrado\" });\n    }\n\n    console.log(\n      \"Remito encontrado. ID de mercadería asociada:\",\n      remito.mercaderiaId\n    );\n\n    // Definir los campos que pertenecen a cada modelo\n    const remitoFields = [\n      \"numeroAsignado\",\n      \"fechaEmision\",\n      \"observaciones\",\n      \"prioridad\",\n      \"clienteId\",\n      \"destinoId\",\n      \"estadoId\",\n    ];\n    const mercaderiaFields = [\n      \"tipoMercaderia\",\n      \"valorDeclarado\",\n      \"volumenMetrosCubico\",\n      \"pesoMercaderia\",\n      \"cantidadBobinas\",\n      \"cantidadRacks\",\n      \"cantidadBultos\",\n      \"cantidadPallets\",\n      \"requisitosEspeciales\",\n    ];\n\n    const remitoUpdateData = {};\n    const mercaderiaUpdateData = {};\n\n    // Separar los datos del body para cada modelo\n    for (const key in data) {\n      if (remitoFields.includes(key)) {\n        remitoUpdateData[key] = data[key];\n      }\n      if (mercaderiaFields.includes(key)) {\n        mercaderiaUpdateData[key] = data[key];\n      }\n    }\n\n    console.log(\"Datos para actualizar Remito:\", remitoUpdateData);\n    await remito.update(remitoUpdateData);\n\n    // Si hay mercadería asociada, actualizarla con sus datos\n    if (remito.mercaderiaId) {\n      const mercaderia = await Mercaderia.findByPk(remito.mercaderiaId);\n      if (mercaderia) {\n        console.log(\"Datos para actualizar Mercaderia:\", mercaderiaUpdateData);\n        await mercaderia.update(mercaderiaUpdateData);\n        console.log(\"Mercadería actualizada exitosamente.\");\n      } else {\n        console.log(\n          \"Error: Mercadería asociada no encontrada con ID:\",\n          remito.mercaderiaId\n        );\n      }\n    } else {\n      console.log(\"Info: El remito no tiene ID de mercadería asociada.\");\n    }\n\n    // Devolver el remito completo y actualizado con todas sus relaciones\n    const remitoActualizado = await Remito.findByPk(id, {\n      include: [\"cliente\", \"destino\", \"estado\", \"mercaderia\"],\n    });\n\n    console.log(\"--- Finalizando actualización de Remito ---\");\n    res.status(200).json(remitoActualizado);\n  } catch (error) {\n    console.error(`Error al actualizar remito con ID ${id}:`, error);\n    res.status(500).json({ message: \"Error al actualizar el remito\" });\n  }\n};\ncontroller.updateRemito = updateRemito;\n\nconst updateEstadoRemito = async (req, res) => {\n  const remitoId = req.params.id;\n  const estId = req.params.eid;\n  const remito = await Remito.findByPk(remitoId);\n  await remito.update({ estadoId: estId });\n  const remitoActualizado = await Remito.findByPk(remitoId, {\n    include: [\n      {\n        model: Cliente,\n        as: \"cliente\",\n      },\n      {\n        model: Destino,\n        as: \"destino\",\n      },\n      {\n        model: Estado,\n        as: \"estado\",\n      },\n    ],\n  });\n  res.status(200).json(remitoActualizado);\n};\ncontroller.updateEstadoRemito = updateEstadoRemito;\n\nconst deleteRemito = async (req, res) => {\n  const id = req.params.id;\n  const remito = await Remito.findByPk(id);\n  await remito.destroy();\n  res.status(200).json({ message: \"Remito eliminado correctamente\" });\n};\ncontroller.deleteRemito = deleteRemito;\n\n// Reporte: Volumen total de mercadería por cliente/período\nconst getVolumenPorClientePeriodo = async (req, res) => {\n  const { clienteId, fechaDesde, fechaHasta } = req.query;\n  const { Remito, Mercaderia, Cliente } = require('../models');\n  try {\n    const where = {};\n    if (clienteId) where.clienteId = clienteId;\n    if (fechaDesde && fechaHasta) {\n      where.fechaEmision = { $between: [fechaDesde, fechaHasta] };\n    } else if (fechaDesde) {\n      where.fechaEmision = { $gte: fechaDesde };\n    } else if (fechaHasta) {\n      where.fechaEmision = { $lte: fechaHasta };\n    }\n    const remitos = await Remito.findAll({\n      where,\n      include: [\n        { model: Mercaderia, as: 'mercaderia' },\n        { model: Cliente, as: 'cliente' }\n      ]\n    });\n    // Agrupar por cliente\n    const resultado = {};\n    remitos.forEach(remito => {\n      const cliente = remito.cliente;\n      const razonSocial = cliente ? cliente.razonSocial : 'Sin cliente';\n      const volumen = remito.mercaderia ? remito.mercaderia.volumenMetrosCubico : 0;\n      if (!resultado[razonSocial]) {\n        resultado[razonSocial] = 0;\n      }\n      resultado[razonSocial] += volumen;\n    });\n    // Formatear para frontend\n    const data = Object.entries(resultado).map(([cliente, volumenTotal]) => ({ cliente, volumenTotal }));\n    res.json(data);\n  } catch (error) {\n    console.error(error);\n    res.status(500).json({ error: 'Error al obtener el reporte de volumen por cliente/período' });\n  }\n};\ncontroller.getVolumenPorClientePeriodo = getVolumenPorClientePeriodo;\n\nmodule.exports = controller;\n"],"file":"remitoController.js"}