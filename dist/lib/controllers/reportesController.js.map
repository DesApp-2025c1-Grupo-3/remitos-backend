{"version":3,"sources":["../../../lib/controllers/reportesController.js"],"names":["Remito","Cliente","Destino","Mercaderia","sequelize","require","Op","controller","getVolumenPorClientePeriodo","req","res","clienteId","fechaDesde","fechaHasta","query","where","fechaEmision","between","gte","lte","remitos","findAll","include","model","as","resultado","forEach","remito","cliente","razonSocial","volumen","mercaderia","volumenMetrosCubico","data","Object","entries","map","volumenTotal","json","error","console","status","getDistribucionGeografica","pais","provincia","localidad","tipo","paisVal","provinciaVal","localidadVal","origen","destino","nombre","key","cantidad","values","getValorPorTipoMercaderia","whereRemito","tipoMercaderia","valor","Number","valorDeclarado","valorTotal","module","exports"],"mappings":"AAAA,MAAM;AAAEA,EAAAA,MAAF;AAAUC,EAAAA,OAAV;AAAmBC,EAAAA,OAAnB;AAA4BC,EAAAA,UAA5B;AAAwCC,EAAAA;AAAxC,IAAsDC,OAAO,CAAC,WAAD,CAAnE;;AACA,MAAM;AAAEC,EAAAA;AAAF,IAASD,OAAO,CAAC,WAAD,CAAtB;;AACA,MAAME,UAAU,GAAG,EAAnB,C,CAEA;;AACAA,UAAU,CAACC,2BAAX,GAAyC,OAAOC,GAAP,EAAYC,GAAZ,KAAoB;AAC3D,QAAM;AAAEC,IAAAA,SAAF;AAAaC,IAAAA,UAAb;AAAyBC,IAAAA;AAAzB,MAAwCJ,GAAG,CAACK,KAAlD;;AACA,MAAI;AACF,UAAMC,KAAK,GAAG,EAAd;AACA,QAAIJ,SAAJ,EAAeI,KAAK,CAACJ,SAAN,GAAkBA,SAAlB;;AACf,QAAIC,UAAU,IAAIC,UAAlB,EAA8B;AAC5BE,MAAAA,KAAK,CAACC,YAAN,GAAqB;AAAE,SAACV,EAAE,CAACW,OAAJ,GAAc,CAACL,UAAD,EAAaC,UAAb;AAAhB,OAArB;AACD,KAFD,MAEO,IAAID,UAAJ,EAAgB;AACrBG,MAAAA,KAAK,CAACC,YAAN,GAAqB;AAAE,SAACV,EAAE,CAACY,GAAJ,GAAUN;AAAZ,OAArB;AACD,KAFM,MAEA,IAAIC,UAAJ,EAAgB;AACrBE,MAAAA,KAAK,CAACC,YAAN,GAAqB;AAAE,SAACV,EAAE,CAACa,GAAJ,GAAUN;AAAZ,OAArB;AACD;;AACD,UAAMO,OAAO,GAAG,MAAMpB,MAAM,CAACqB,OAAP,CAAe;AACnCN,MAAAA,KADmC;AAEnCO,MAAAA,OAAO,EAAE,CACP;AAAEC,QAAAA,KAAK,EAAEpB,UAAT;AAAqBqB,QAAAA,EAAE,EAAE;AAAzB,OADO,EAEP;AAAED,QAAAA,KAAK,EAAEtB,OAAT;AAAkBuB,QAAAA,EAAE,EAAE;AAAtB,OAFO;AAF0B,KAAf,CAAtB;AAOA,UAAMC,SAAS,GAAG,EAAlB;AACAL,IAAAA,OAAO,CAACM,OAAR,CAAiBC,MAAD,IAAY;AAC1B,YAAMC,OAAO,GAAGD,MAAM,CAACC,OAAvB;AACA,YAAMC,WAAW,GAAGD,OAAO,GAAGA,OAAO,CAACC,WAAX,GAAyB,aAApD;AACA,YAAMC,OAAO,GAAGH,MAAM,CAACI,UAAP,GAAoBJ,MAAM,CAACI,UAAP,CAAkBC,mBAAtC,GAA4D,CAA5E;AACA,UAAI,CAACP,SAAS,CAACI,WAAD,CAAd,EAA6BJ,SAAS,CAACI,WAAD,CAAT,GAAyB,CAAzB;AAC7BJ,MAAAA,SAAS,CAACI,WAAD,CAAT,IAA0BC,OAA1B;AACD,KAND;AAOA,UAAMG,IAAI,GAAGC,MAAM,CAACC,OAAP,CAAeV,SAAf,EAA0BW,GAA1B,CAA8B,CAAC,CAACR,OAAD,EAAUS,YAAV,CAAD,MAA8B;AAAET,MAAAA,OAAF;AAAWS,MAAAA;AAAX,KAA9B,CAA9B,CAAb;AACA3B,IAAAA,GAAG,CAAC4B,IAAJ,CAASL,IAAT;AACD,GA3BD,CA2BE,OAAOM,KAAP,EAAc;AACdC,IAAAA,OAAO,CAACD,KAAR,CAAcA,KAAd;AACA7B,IAAAA,GAAG,CAAC+B,MAAJ,CAAW,GAAX,EAAgBH,IAAhB,CAAqB;AAAEC,MAAAA,KAAK,EAAE;AAAT,KAArB;AACD;AACF,CAjCD,C,CAmCA;;;AACAhC,UAAU,CAACmC,yBAAX,GAAuC,OAAOjC,GAAP,EAAYC,GAAZ,KAAoB;AACzD,QAAM;AAAEiC,IAAAA,IAAF;AAAQC,IAAAA,SAAR;AAAmBC,IAAAA,SAAnB;AAA8BC,IAAAA,IAA9B;AAAoCnC,IAAAA,SAApC;AAA+CC,IAAAA,UAA/C;AAA2DC,IAAAA;AAA3D,MAA0EJ,GAAG,CAACK,KAApF;;AACA,MAAI;AACF,UAAMC,KAAK,GAAG,EAAd;AACA,QAAIJ,SAAJ,EAAeI,KAAK,CAACJ,SAAN,GAAkBA,SAAlB;;AACf,QAAIC,UAAU,IAAIC,UAAlB,EAA8B;AAC5BE,MAAAA,KAAK,CAACC,YAAN,GAAqB;AAAE,SAACV,EAAE,CAACW,OAAJ,GAAc,CAACL,UAAD,EAAaC,UAAb;AAAhB,OAArB;AACD,KAFD,MAEO,IAAID,UAAJ,EAAgB;AACrBG,MAAAA,KAAK,CAACC,YAAN,GAAqB;AAAE,SAACV,EAAE,CAACY,GAAJ,GAAUN;AAAZ,OAArB;AACD,KAFM,MAEA,IAAIC,UAAJ,EAAgB;AACrBE,MAAAA,KAAK,CAACC,YAAN,GAAqB;AAAE,SAACV,EAAE,CAACa,GAAJ,GAAUN;AAAZ,OAArB;AACD;;AACD,UAAMS,OAAO,GAAG,CACd;AAAEC,MAAAA,KAAK,EAAErB,OAAT;AAAkBsB,MAAAA,EAAE,EAAE;AAAtB,KADc,EAEd;AAAED,MAAAA,KAAK,EAAEtB,OAAT;AAAkBuB,MAAAA,EAAE,EAAE;AAAtB,KAFc,CAAhB;AAIA,UAAMJ,OAAO,GAAG,MAAMpB,MAAM,CAACqB,OAAP,CAAe;AAAEN,MAAAA,KAAF;AAASO,MAAAA;AAAT,KAAf,CAAtB,CAdE,CAeF;;AACA,UAAMG,SAAS,GAAG,EAAlB;AACAL,IAAAA,OAAO,CAACM,OAAR,CAAiBC,MAAD,IAAY;AAC1B,UAAIoB,OAAO,GAAG,GAAd;AAAA,UAAmBC,YAAY,GAAG,GAAlC;AAAA,UAAuCC,YAAY,GAAG,GAAtD;AAAA,UAA2DC,MAAM,GAAG,GAApE;AAAA,UAAyEC,OAAO,GAAG,GAAnF;;AACA,UAAIL,IAAI,KAAK,QAAb,EAAuB;AACrBI,QAAAA,MAAM,GAAGvB,MAAM,CAACC,OAAP,GAAiBD,MAAM,CAACC,OAAP,CAAeC,WAAhC,GAA8C,aAAvD;AACAkB,QAAAA,OAAO,GAAGpB,MAAM,CAACC,OAAP,IAAkBD,MAAM,CAACC,OAAP,CAAee,IAAjC,GAAwChB,MAAM,CAACC,OAAP,CAAee,IAAvD,GAA8D,GAAxE;AACAK,QAAAA,YAAY,GAAGrB,MAAM,CAACC,OAAP,IAAkBD,MAAM,CAACC,OAAP,CAAegB,SAAjC,GAA6CjB,MAAM,CAACC,OAAP,CAAegB,SAA5D,GAAwE,GAAvF;AACAK,QAAAA,YAAY,GAAGtB,MAAM,CAACC,OAAP,IAAkBD,MAAM,CAACC,OAAP,CAAeiB,SAAjC,GAA6ClB,MAAM,CAACC,OAAP,CAAeiB,SAA5D,GAAwE,GAAvF;AACD,OALD,MAKO;AACLM,QAAAA,OAAO,GAAGxB,MAAM,CAACwB,OAAP,GAAiBxB,MAAM,CAACwB,OAAP,CAAeC,MAAhC,GAAyC,aAAnD;AACAL,QAAAA,OAAO,GAAGpB,MAAM,CAACwB,OAAP,IAAkBxB,MAAM,CAACwB,OAAP,CAAeR,IAAjC,GAAwChB,MAAM,CAACwB,OAAP,CAAeR,IAAvD,GAA8D,GAAxE;AACAK,QAAAA,YAAY,GAAGrB,MAAM,CAACwB,OAAP,IAAkBxB,MAAM,CAACwB,OAAP,CAAeP,SAAjC,GAA6CjB,MAAM,CAACwB,OAAP,CAAeP,SAA5D,GAAwE,GAAvF;AACAK,QAAAA,YAAY,GAAGtB,MAAM,CAACwB,OAAP,IAAkBxB,MAAM,CAACwB,OAAP,CAAeN,SAAjC,GAA6ClB,MAAM,CAACwB,OAAP,CAAeN,SAA5D,GAAwE,GAAvF;AACD,OAZyB,CAa1B;;;AACA,UAAIF,IAAI,IAAII,OAAO,KAAKJ,IAAxB,EAA8B;AAC9B,UAAIC,SAAS,IAAII,YAAY,KAAKJ,SAAlC,EAA6C;AAC7C,UAAIC,SAAS,IAAII,YAAY,KAAKJ,SAAlC,EAA6C;AAC7C,YAAMQ,GAAG,GAAI,GAAEN,OAAQ,IAAGC,YAAa,IAAGC,YAAa,IAAGC,MAAO,IAAGC,OAAQ,EAA5E;AACA,UAAI,CAAC1B,SAAS,CAAC4B,GAAD,CAAd,EAAqB5B,SAAS,CAAC4B,GAAD,CAAT,GAAiB;AAAEV,QAAAA,IAAI,EAAEI,OAAR;AAAiBH,QAAAA,SAAS,EAAEI,YAA5B;AAA0CH,QAAAA,SAAS,EAAEI,YAArD;AAAmEC,QAAAA,MAAnE;AAA2EC,QAAAA,OAA3E;AAAoFG,QAAAA,QAAQ,EAAE;AAA9F,OAAjB;AACrB7B,MAAAA,SAAS,CAAC4B,GAAD,CAAT,CAAeC,QAAf,IAA2B,CAA3B;AACD,KApBD;AAqBA,UAAMrB,IAAI,GAAGC,MAAM,CAACqB,MAAP,CAAc9B,SAAd,CAAb;AACAf,IAAAA,GAAG,CAAC4B,IAAJ,CAASL,IAAT;AACD,GAxCD,CAwCE,OAAOM,KAAP,EAAc;AACdC,IAAAA,OAAO,CAACD,KAAR,CAAcA,KAAd;AACA7B,IAAAA,GAAG,CAAC+B,MAAJ,CAAW,GAAX,EAAgBH,IAAhB,CAAqB;AAAEC,MAAAA,KAAK,EAAE;AAAT,KAArB;AACD;AACF,CA9CD,C,CAgDA;;;AACAhC,UAAU,CAACiD,yBAAX,GAAuC,OAAO/C,GAAP,EAAYC,GAAZ,KAAoB;AACzD,QAAM;AAAEC,IAAAA,SAAF;AAAaC,IAAAA,UAAb;AAAyBC,IAAAA;AAAzB,MAAwCJ,GAAG,CAACK,KAAlD;;AACA,MAAI;AACF,UAAM2C,WAAW,GAAG,EAApB;AACA,QAAI9C,SAAJ,EAAe8C,WAAW,CAAC9C,SAAZ,GAAwBA,SAAxB;;AACf,QAAIC,UAAU,IAAIC,UAAlB,EAA8B;AAC5B4C,MAAAA,WAAW,CAACzC,YAAZ,GAA2B;AAAE,SAACV,EAAE,CAACW,OAAJ,GAAc,CAACL,UAAD,EAAaC,UAAb;AAAhB,OAA3B;AACD,KAFD,MAEO,IAAID,UAAJ,EAAgB;AACrB6C,MAAAA,WAAW,CAACzC,YAAZ,GAA2B;AAAE,SAACV,EAAE,CAACY,GAAJ,GAAUN;AAAZ,OAA3B;AACD,KAFM,MAEA,IAAIC,UAAJ,EAAgB;AACrB4C,MAAAA,WAAW,CAACzC,YAAZ,GAA2B;AAAE,SAACV,EAAE,CAACa,GAAJ,GAAUN;AAAZ,OAA3B;AACD;;AACD,UAAMO,OAAO,GAAG,MAAMpB,MAAM,CAACqB,OAAP,CAAe;AACnCN,MAAAA,KAAK,EAAE0C,WAD4B;AAEnCnC,MAAAA,OAAO,EAAE,CACP;AAAEC,QAAAA,KAAK,EAAEpB,UAAT;AAAqBqB,QAAAA,EAAE,EAAE;AAAzB,OADO;AAF0B,KAAf,CAAtB,CAVE,CAgBF;;AACA,UAAMC,SAAS,GAAG,EAAlB;AACAL,IAAAA,OAAO,CAACM,OAAR,CAAiBC,MAAD,IAAY;AAC1B,YAAMmB,IAAI,GAAGnB,MAAM,CAACI,UAAP,GAAoBJ,MAAM,CAACI,UAAP,CAAkB2B,cAAtC,GAAuD,UAApE;AACA,YAAMC,KAAK,GAAGhC,MAAM,CAACI,UAAP,GAAoB6B,MAAM,CAACjC,MAAM,CAACI,UAAP,CAAkB8B,cAAnB,CAA1B,GAA+D,CAA7E;AACA,UAAI,CAACpC,SAAS,CAACqB,IAAD,CAAd,EAAsBrB,SAAS,CAACqB,IAAD,CAAT,GAAkB,CAAlB;AACtBrB,MAAAA,SAAS,CAACqB,IAAD,CAAT,IAAmBa,KAAnB;AACD,KALD;AAMA,UAAM1B,IAAI,GAAGC,MAAM,CAACC,OAAP,CAAeV,SAAf,EAA0BW,GAA1B,CAA8B,CAAC,CAACU,IAAD,EAAOgB,UAAP,CAAD,MAAyB;AAAEhB,MAAAA,IAAF;AAAQgB,MAAAA;AAAR,KAAzB,CAA9B,CAAb;AACApD,IAAAA,GAAG,CAAC4B,IAAJ,CAASL,IAAT;AACD,GA1BD,CA0BE,OAAOM,KAAP,EAAc;AACdC,IAAAA,OAAO,CAACD,KAAR,CAAcA,KAAd;AACA7B,IAAAA,GAAG,CAAC+B,MAAJ,CAAW,GAAX,EAAgBH,IAAhB,CAAqB;AAAEC,MAAAA,KAAK,EAAE;AAAT,KAArB;AACD;AACF,CAhCD;;AAkCAwB,MAAM,CAACC,OAAP,GAAiBzD,UAAjB","sourcesContent":["const { Remito, Cliente, Destino, Mercaderia, sequelize } = require(\"../models\");\r\nconst { Op } = require(\"sequelize\");\r\nconst controller = {};\r\n\r\n// 1. Volumen total de mercadería por cliente/período\r\ncontroller.getVolumenPorClientePeriodo = async (req, res) => {\r\n  const { clienteId, fechaDesde, fechaHasta } = req.query;\r\n  try {\r\n    const where = {};\r\n    if (clienteId) where.clienteId = clienteId;\r\n    if (fechaDesde && fechaHasta) {\r\n      where.fechaEmision = { [Op.between]: [fechaDesde, fechaHasta] };\r\n    } else if (fechaDesde) {\r\n      where.fechaEmision = { [Op.gte]: fechaDesde };\r\n    } else if (fechaHasta) {\r\n      where.fechaEmision = { [Op.lte]: fechaHasta };\r\n    }\r\n    const remitos = await Remito.findAll({\r\n      where,\r\n      include: [\r\n        { model: Mercaderia, as: \"mercaderia\" },\r\n        { model: Cliente, as: \"cliente\" },\r\n      ],\r\n    });\r\n    const resultado = {};\r\n    remitos.forEach((remito) => {\r\n      const cliente = remito.cliente;\r\n      const razonSocial = cliente ? cliente.razonSocial : \"Sin cliente\";\r\n      const volumen = remito.mercaderia ? remito.mercaderia.volumenMetrosCubico : 0;\r\n      if (!resultado[razonSocial]) resultado[razonSocial] = 0;\r\n      resultado[razonSocial] += volumen;\r\n    });\r\n    const data = Object.entries(resultado).map(([cliente, volumenTotal]) => ({ cliente, volumenTotal }));\r\n    res.json(data);\r\n  } catch (error) {\r\n    console.error(error);\r\n    res.status(500).json({ error: \"Error al obtener el reporte de volumen por cliente/período\" });\r\n  }\r\n};\r\n\r\n// 2. Distribución geográfica de orígenes y destinos\r\ncontroller.getDistribucionGeografica = async (req, res) => {\r\n  const { pais, provincia, localidad, tipo, clienteId, fechaDesde, fechaHasta } = req.query;\r\n  try {\r\n    const where = {};\r\n    if (clienteId) where.clienteId = clienteId;\r\n    if (fechaDesde && fechaHasta) {\r\n      where.fechaEmision = { [Op.between]: [fechaDesde, fechaHasta] };\r\n    } else if (fechaDesde) {\r\n      where.fechaEmision = { [Op.gte]: fechaDesde };\r\n    } else if (fechaHasta) {\r\n      where.fechaEmision = { [Op.lte]: fechaHasta };\r\n    }\r\n    const include = [\r\n      { model: Destino, as: \"destino\" },\r\n      { model: Cliente, as: \"cliente\" },\r\n    ];\r\n    const remitos = await Remito.findAll({ where, include });\r\n    // Agrupar por país, provincia, localidad, origen/destino\r\n    const resultado = {};\r\n    remitos.forEach((remito) => {\r\n      let paisVal = \"-\", provinciaVal = \"-\", localidadVal = \"-\", origen = \"-\", destino = \"-\";\r\n      if (tipo === \"origen\") {\r\n        origen = remito.cliente ? remito.cliente.razonSocial : \"Sin cliente\";\r\n        paisVal = remito.cliente && remito.cliente.pais ? remito.cliente.pais : \"-\";\r\n        provinciaVal = remito.cliente && remito.cliente.provincia ? remito.cliente.provincia : \"-\";\r\n        localidadVal = remito.cliente && remito.cliente.localidad ? remito.cliente.localidad : \"-\";\r\n      } else {\r\n        destino = remito.destino ? remito.destino.nombre : \"Sin destino\";\r\n        paisVal = remito.destino && remito.destino.pais ? remito.destino.pais : \"-\";\r\n        provinciaVal = remito.destino && remito.destino.provincia ? remito.destino.provincia : \"-\";\r\n        localidadVal = remito.destino && remito.destino.localidad ? remito.destino.localidad : \"-\";\r\n      }\r\n      // Filtros\r\n      if (pais && paisVal !== pais) return;\r\n      if (provincia && provinciaVal !== provincia) return;\r\n      if (localidad && localidadVal !== localidad) return;\r\n      const key = `${paisVal}|${provinciaVal}|${localidadVal}|${origen}|${destino}`;\r\n      if (!resultado[key]) resultado[key] = { pais: paisVal, provincia: provinciaVal, localidad: localidadVal, origen, destino, cantidad: 0 };\r\n      resultado[key].cantidad += 1;\r\n    });\r\n    const data = Object.values(resultado);\r\n    res.json(data);\r\n  } catch (error) {\r\n    console.error(error);\r\n    res.status(500).json({ error: \"Error al obtener la distribución geográfica\" });\r\n  }\r\n};\r\n\r\n// 3. Valor declarado por tipo de mercadería\r\ncontroller.getValorPorTipoMercaderia = async (req, res) => {\r\n  const { clienteId, fechaDesde, fechaHasta } = req.query;\r\n  try {\r\n    const whereRemito = {};\r\n    if (clienteId) whereRemito.clienteId = clienteId;\r\n    if (fechaDesde && fechaHasta) {\r\n      whereRemito.fechaEmision = { [Op.between]: [fechaDesde, fechaHasta] };\r\n    } else if (fechaDesde) {\r\n      whereRemito.fechaEmision = { [Op.gte]: fechaDesde };\r\n    } else if (fechaHasta) {\r\n      whereRemito.fechaEmision = { [Op.lte]: fechaHasta };\r\n    }\r\n    const remitos = await Remito.findAll({\r\n      where: whereRemito,\r\n      include: [\r\n        { model: Mercaderia, as: \"mercaderia\" },\r\n      ],\r\n    });\r\n    // Agrupar por tipo de mercadería\r\n    const resultado = {};\r\n    remitos.forEach((remito) => {\r\n      const tipo = remito.mercaderia ? remito.mercaderia.tipoMercaderia : \"Sin tipo\";\r\n      const valor = remito.mercaderia ? Number(remito.mercaderia.valorDeclarado) : 0;\r\n      if (!resultado[tipo]) resultado[tipo] = 0;\r\n      resultado[tipo] += valor;\r\n    });\r\n    const data = Object.entries(resultado).map(([tipo, valorTotal]) => ({ tipo, valorTotal }));\r\n    res.json(data);\r\n  } catch (error) {\r\n    console.error(error);\r\n    res.status(500).json({ error: \"Error al obtener el valor declarado por tipo de mercadería\" });\r\n  }\r\n};\r\n\r\nmodule.exports = controller; "],"file":"reportesController.js"}