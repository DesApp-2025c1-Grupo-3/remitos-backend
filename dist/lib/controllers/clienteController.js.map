{"version":3,"sources":["../../../lib/controllers/clienteController.js"],"names":["where","require","Cliente","Contacto","sequelize","message","controller","getCliente","req","res","page","parseInt","query","limit","offset","razonSocial","Op","iLike","cuit_rut","direccion","count","rows","findAndCountAll","include","model","as","order","status","json","data","totalItems","totalPages","Math","ceil","currentPage","error","console","getClienteById","id","params","cliente","findByPk","createCliente","t","transaction","contactos","clienteData","body","create","Array","isArray","length","contacto","clienteId","commit","clienteConContactos","rollback","createClienteWithContacto","tipoEmpresa","personaAutorizada","correoElectronico","telefono","nuevoContacto","deleteCliente","idCliente","destroy","updateCliente","update","clienteActualizado","module","exports"],"mappings":"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","sourcesContent":["const { where } = require(\"sequelize\");\nconst { Cliente, Contacto, sequelize } = require(\"../models\");\nconst { message } = require(\"../schemas/estadoSchema\");\nconst controller = {};\n\nconst getCliente = async (req, res) => {\n  try {\n    const page = parseInt(req.query.page, 10) || 1;\n    const limit = parseInt(req.query.limit, 10) || 20;\n    const offset = (page - 1) * limit;\n\n    // Filtros de bÃºsqueda\n    const where = {};\n    if (req.query.razonSocial) {\n      where.razonSocial = {\n        [require(\"sequelize\").Op.iLike]: `%${req.query.razonSocial}%`,\n      };\n    }\n    if (req.query.cuit_rut) {\n      where.cuit_rut = {\n        [require(\"sequelize\").Op.iLike]: `%${req.query.cuit_rut}%`,\n      };\n    }\n    if (req.query.direccion) {\n      where.direccion = {\n        [require(\"sequelize\").Op.iLike]: `%${req.query.direccion}%`,\n      };\n    }\n\n    const { count, rows } = await Cliente.findAndCountAll({\n      where,\n      limit,\n      offset,\n      include: {\n        model: Contacto,\n        as: \"contactos\",\n      },\n      order: [[\"createdAt\", \"DESC\"]],\n    });\n\n    res.status(200).json({\n      data: rows,\n      totalItems: count,\n      totalPages: Math.ceil(count / limit),\n      currentPage: page,\n    });\n  } catch (error) {\n    console.error(\"Error al obtener clientes:\", error);\n    res.status(500).json({ message: \"Error al obtener los clientes\" });\n  }\n};\ncontroller.getCliente = getCliente;\n\nconst getClienteById = async (req, res) => {\n  const id = req.params.id;\n  const cliente = await Cliente.findByPk(id, {\n    include: {\n      model: Contacto,\n      as: \"contactos\",\n    },\n  });\n  res.status(200).json(cliente);\n};\ncontroller.getClienteById = getClienteById;\n\nconst createCliente = async (req, res) => {\n  const t = await sequelize.transaction();\n\n  try {\n    const { contactos, ...clienteData } = req.body;\n\n    const cliente = await Cliente.create(clienteData, { transaction: t });\n\n    // Crear contactos si se proporcionan\n    if (contactos && Array.isArray(contactos) && contactos.length > 0) {\n      for (const contacto of contactos) {\n        await Contacto.create(\n          {\n            ...contacto,\n            clienteId: cliente.id,\n          },\n          { transaction: t }\n        );\n      }\n    }\n\n    await t.commit();\n\n    // Devolver cliente con contactos\n    const clienteConContactos = await Cliente.findByPk(cliente.id, {\n      include: {\n        model: Contacto,\n        as: \"contactos\",\n      },\n    });\n\n    res.status(201).json(clienteConContactos);\n  } catch (error) {\n    await t.rollback();\n    console.error(\"Error al crear cliente:\", error);\n    res.status(500).json({ message: \"Error al crear el cliente\" });\n  }\n};\ncontroller.createCliente = createCliente;\n\nconst createClienteWithContacto = async (req, res) => {\n  const t = await sequelize.transaction();\n\n  try {\n    const {\n      razonSocial,\n      cuit_rut,\n      direccion,\n      tipoEmpresa,\n      personaAutorizada,\n      correoElectronico,\n      telefono,\n    } = req.body;\n\n    const cliente = await Cliente.create(\n      {\n        razonSocial,\n        cuit_rut,\n        direccion,\n        tipoEmpresa,\n      },\n      { transaction: t }\n    );\n\n    const nuevoContacto = await Contacto.create(\n      {\n        personaAutorizada,\n        correoElectronico,\n        telefono,\n        clienteId: cliente.id,\n      },\n      { transaction: t }\n    );\n\n    await t.commit();\n\n    const clienteConContactos = await Cliente.findByPk(cliente.id, {\n      include: {\n        model: Contacto,\n        as: \"contactos\",\n      },\n    });\n    res.status(201).json(clienteConContactos);\n  } catch (error) {\n    await t.rollback();\n    console.error(\"Error al crear cliente con contacto:\", error);\n    res.status(500).json({ message: \"Error al crear el cliente con contacto\" });\n  }\n};\ncontroller.createClienteWithContacto = createClienteWithContacto;\n\nconst deleteCliente = async (req, res) => {\n  const t = await sequelize.transaction();\n\n  try {\n    const idCliente = req.params.id;\n\n    // Eliminar contactos primero\n    await Contacto.destroy({\n      where: { clienteId: idCliente },\n      transaction: t,\n    });\n\n    // Luego eliminar cliente\n    await Cliente.destroy({\n      where: { id: idCliente },\n      transaction: t,\n    });\n\n    await t.commit();\n    res.status(200).json({ message: \"Cliente eliminado correctamente\" });\n  } catch (error) {\n    await t.rollback();\n    console.error(\"Error al eliminar cliente:\", error);\n    res.status(500).json({ message: \"Error al eliminar el cliente\" });\n  }\n};\ncontroller.deleteCliente = deleteCliente;\n\nconst updateCliente = async (req, res) => {\n  const t = await sequelize.transaction();\n\n  try {\n    const idCliente = req.params.id;\n    const { contactos, ...clienteData } = req.body;\n\n    const cliente = await Cliente.findByPk(idCliente);\n    if (!cliente) {\n      await t.rollback();\n      return res.status(404).json({ message: \"Cliente no encontrado\" });\n    }\n\n    await cliente.update(clienteData, { transaction: t });\n\n    // Actualizar contactos si se proporcionan\n    if (contactos && Array.isArray(contactos)) {\n      // Eliminar contactos existentes\n      await Contacto.destroy({\n        where: { clienteId: idCliente },\n        transaction: t,\n      });\n\n      // Crear nuevos contactos\n      for (const contacto of contactos) {\n        await Contacto.create(\n          {\n            ...contacto,\n            clienteId: idCliente,\n          },\n          { transaction: t }\n        );\n      }\n    }\n\n    await t.commit();\n\n    // Devolver cliente actualizado con contactos\n    const clienteActualizado = await Cliente.findByPk(idCliente, {\n      include: {\n        model: Contacto,\n        as: \"contactos\",\n      },\n    });\n\n    res.status(200).json(clienteActualizado);\n  } catch (error) {\n    await t.rollback();\n    console.error(\"Error al actualizar cliente:\", error);\n    res.status(500).json({ message: \"Error al actualizar el cliente\" });\n  }\n};\ncontroller.updateCliente = updateCliente;\n\nmodule.exports = controller;\n"],"file":"clienteController.js"}