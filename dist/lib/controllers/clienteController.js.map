{"version":3,"sources":["../../../lib/controllers/clienteController.js"],"names":["Cliente","require","Contacto","cliente","controller","getCliente","req","res","page","parseInt","params","limit","offset","count","rows","findAndCountAll","where","activo","include","model","as","order","responseData","totalItems","totalPages","Math","ceil","currentPage","data","status","json","error","console","message","getClienteById","id","clienteDB","findByPk","createCliente","clienteNuevo","body","nuevoCliente","create","createClienteWithContacto","razonSocial","cuit_rut","direccion","tipoEmpresa","personaAutorizada","correoElectronico","telefono","newCliente","nuevoContacto","clienteId","clienteConContactos","deleteCliente","idCliente","clienteToDelete","update","activateCliente","clienteToActivate","updateCliente","clienteToUpdate","module","exports"],"mappings":"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","sourcesContent":["const { Cliente } = require(\"../models\");\r\nconst { Contacto } = require(\"../models\");\r\nconst cliente = require('../config/redis'); // Asumo que 'cliente' es tu cliente Redis\r\nconst controller = {};\r\n\r\n\r\nconst getCliente = async (req, res) => {\r\n  try {\r\n    const page = parseInt(req.params.page) || 1;\r\n    const limit = parseInt(req.params.limit) || 20;\r\n    const offset = (page - 1) * limit; // Permite saltear los que son de páginas anteriores\r\n\r\n    const { count, rows } = await Cliente.findAndCountAll({\r\n      where: { activo: true },\r\n      include: {\r\n        model: Contacto,\r\n        as: \"contactos\",\r\n      },\r\n      limit,\r\n      offset,\r\n      order: [[\"createdAt\", \"DESC\"]],\r\n    });\r\n\r\n    const responseData = {\r\n      totalItems: count,\r\n      totalPages: Math.ceil(count / limit),\r\n      currentPage: page,\r\n      data: rows,\r\n    };\r\n\r\n    return res.status(200).json(responseData);\r\n  } catch (error) {\r\n    console.error(\"Error en getCliente:\", error);\r\n    return res.status(500).json({ message: \"Error interno del servidor al obtener clientes.\" });\r\n  }\r\n};\r\ncontroller.getCliente = getCliente;\r\n\r\nconst getClienteById = async (req, res) => {\r\n  try {\r\n    const id = req.params.id;\r\n    const clienteDB = await Cliente.findByPk(id, {\r\n      include: {\r\n        model: Contacto,\r\n        as: \"contactos\",\r\n      },\r\n    });\r\n    if (!clienteDB) { // Maneja el caso en que el cliente no se encuentra en la DB\r\n      return res.status(404).json({ message: \"Cliente no encontrado.\" });\r\n    }\r\n\r\n    return res.status(200).json(clienteDB);\r\n  } catch (error) {\r\n    console.error(\"Error en getClienteById:\", error);\r\n    return res.status(500).json({ message: \"Error interno del servidor.\" });\r\n  }\r\n};\r\ncontroller.getClienteById = getClienteById;\r\n\r\nconst createCliente = async (req, res) => {\r\n  try {\r\n    const clienteNuevo = req.body;\r\n    const nuevoCliente = await Cliente.create(clienteNuevo);\r\n    return res.status(201).json(nuevoCliente);\r\n  } catch (error) {\r\n    console.error(\"Error en createCliente:\", error);\r\n    return res.status(500).json({ message: \"Error interno del servidor al crear cliente.\" });\r\n  }\r\n};\r\ncontroller.createCliente = createCliente;\r\n\r\nconst createClienteWithContacto = async (req, res) => {\r\n  try {\r\n    const {\r\n      razonSocial,\r\n      cuit_rut,\r\n      direccion,\r\n      tipoEmpresa,\r\n      personaAutorizada,\r\n      correoElectronico,\r\n      telefono,\r\n    } = req.body;\r\n    const newCliente = await Cliente.create({\r\n      razonSocial,\r\n      cuit_rut,\r\n      direccion,\r\n      tipoEmpresa,\r\n    });\r\n    // Validar si el cliente se creó correctamente antes de intentar crear un contacto\r\n    if (!newCliente) {\r\n      return res.status(500).json({ message: \"No se pudo crear el cliente.\" });\r\n    }\r\n    const nuevoContacto = await Contacto.create({\r\n      personaAutorizada,\r\n      correoElectronico,\r\n      telefono,\r\n      clienteId: newCliente.id,\r\n    });\r\n\r\n    const clienteConContactos = await Cliente.findByPk(newCliente.id, {\r\n      include: {\r\n        model: Contacto,\r\n        as: \"contactos\",\r\n      },\r\n    });\r\n\r\n    return res.status(200).json(clienteConContactos);\r\n  } catch (error) {\r\n    console.error(\"Error en createClienteWithContacto:\", error);\r\n    return res.status(500).json({ message: \"Error interno del servidor al crear cliente con contacto.\" });\r\n  }\r\n};\r\ncontroller.createClienteWithContacto = createClienteWithContacto;\r\n\r\nconst deleteCliente = async (req, res) => {\r\n  try {\r\n    const idCliente = req.params.id;\r\n    const clienteToDelete = await Cliente.findByPk(idCliente);\r\n\r\n    if (!clienteToDelete) {\r\n      return res.status(404).json({ message: \"Cliente no encontrado para eliminar.\" });\r\n    }\r\n    await clienteToDelete.update({ activo: false });\r\n\r\n    return res.status(200).json({ message: \"Cliente eliminado correctamente\" });\r\n  } catch (error) {\r\n    console.error(\"Error en deleteCliente:\", error);\r\n    return res.status(500).json({ message: \"Error interno del servidor al eliminar cliente.\" });\r\n  }\r\n};\r\ncontroller.deleteCliente = deleteCliente;\r\n\r\nconst activateCliente = async (req, res) => {\r\n  try {\r\n    const idCliente = req.params.id;\r\n    const clienteToActivate = await Cliente.findByPk(idCliente);\r\n\r\n    if (!clienteToActivate) {\r\n      return res.status(404).json({ message: \"Cliente no encontrado para activar.\" });\r\n    }\r\n\r\n    await clienteToActivate.update({ activo: true });\r\n\r\n    return res.status(200).json(clienteToActivate);\r\n  } catch (error) {\r\n    console.error(\"Error en activateCliente:\", error);\r\n    return res.status(500).json({ message: \"Error interno del servidor al activar cliente.\" });\r\n  }\r\n};\r\ncontroller.activateCliente = activateCliente;\r\n\r\n\r\nconst updateCliente = async (req, res) => {\r\n  try {\r\n    const idCliente = req.params.id;\r\n    const { razonSocial, cuit_rut, direccion, tipoEmpresa } = req.body;\r\n    const clienteToUpdate = await Cliente.findByPk(idCliente);\r\n\r\n    if (!clienteToUpdate) {\r\n      return res.status(404).json({ error: \"Cliente no encontrado\" });\r\n    }\r\n    await clienteToUpdate.update({ razonSocial, cuit_rut, direccion, tipoEmpresa });\r\n    return res.status(200).json(clienteToUpdate);\r\n  } catch (error) {\r\n    console.error(\"Error en updateCliente:\", error);\r\n    return res.status(500).json({ error: \"Error del servidor al actualizar cliente.\" });\r\n  }\r\n};\r\ncontroller.updateCliente = updateCliente;\r\n\r\nmodule.exports = controller;"],"file":"clienteController.js"}