{"version":3,"sources":["../../../lib/routes/remito.routes.js"],"names":["express","require","route","Router","multer","path","fs","remitoController","schemaValidator","remitoMiddleware","remitoSchema","upload","handleMulterError","error","req","res","next","MulterError","code","status","json","message","get","getRemitos","validateRemitoId","getRemitoById","post","single","validateNumeroAsignadoUnico","createRemito","createRemitoWithClienteAndDestino","put","validateNumeroAsignadoUnicoUpdate","updateRemito","updateEstadoRemito","delete","deleteRemito","getVolumenPorClientePeriodo","filename","params","includes","filePath","join","__dirname","existsSync","sendFile","module","exports"],"mappings":"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","sourcesContent":["const express = require(\"express\");\r\nconst route = express.Router();\r\nconst multer = require(\"multer\");\r\nconst path = require(\"path\");\r\nconst fs = require(\"fs\");\r\nconst remitoController = require(\"../controllers/remitoController\");\r\nconst schemaValidator = require(\"../middlewares/schemaValidator\");\r\nconst remitoMiddleware = require(\"../middlewares/remitoMiddleware\");\r\nconst remitoSchema = require(\"../schemas/remitoSchema\");\r\nconst upload = require(\"../middlewares/upload\");\r\n\r\n// Middleware para manejar errores de multer\r\nconst handleMulterError = (error, req, res, next) => {\r\n  if (error instanceof multer.MulterError) {\r\n    if (error.code === 'LIMIT_FILE_SIZE') {\r\n      return res.status(400).json({ \r\n        error: 'El archivo es demasiado grande. Máximo 5MB.' \r\n      });\r\n    }\r\n    return res.status(400).json({ \r\n      error: 'Error al subir el archivo.' \r\n    });\r\n  } else if (error) {\r\n    return res.status(400).json({ \r\n      error: error.message \r\n    });\r\n  }\r\n  next();\r\n};\r\n\r\n//Trae todos los remitos\r\nroute.get(\"/remito\", remitoController.getRemitos);\r\n//Trae remito por id\r\nroute.get(\r\n  \"/remito/:id\",\r\n  remitoMiddleware.validateRemitoId,\r\n  remitoController.getRemitoById\r\n);\r\n//CREA SOLO EL MODELO REMITO CON SUS ATRIBUTOS\r\nroute.post(\r\n  \"/remito\",\r\n  upload.single(\"archivoAdjunto\"),\r\n  handleMulterError,\r\n  schemaValidator(remitoSchema),\r\n  remitoMiddleware.validateNumeroAsignadoUnico,\r\n  remitoController.createRemito\r\n);\r\n//CREA EL REMITO CON DESTINO Y SU CONTACTO Y CLIENTE Y SU CONTACTO\r\nroute.post(\r\n  \"/remitoFinal\",\r\n  upload.single(\"archivoAdjunto\"),\r\n  handleMulterError,\r\n  //schemaValidator(remitoSchema),\r\n  remitoMiddleware.validateNumeroAsignadoUnico,\r\n  remitoController.createRemitoWithClienteAndDestino\r\n);\r\n//Edita remito\r\nroute.put(\r\n  \"/remito/:id\",\r\n  remitoMiddleware.validateRemitoId,\r\n  remitoMiddleware.validateNumeroAsignadoUnicoUpdate,\r\n  remitoController.updateRemito\r\n);\r\n//Edita estado de un remito\r\nroute.put(\"/remito/:id/estado/:eid\", remitoController.updateEstadoRemito);\r\n\r\n//Borra remito\r\nroute.delete(\r\n  \"/remito/:id\",\r\n  remitoMiddleware.validateRemitoId,\r\n  remitoController.deleteRemito\r\n);\r\n\r\nroute.get(\r\n  \"/reportes/volumen-por-cliente-periodo\",\r\n  remitoController.getVolumenPorClientePeriodo\r\n);\r\n\r\n// Endpoint para servir archivos de manera segura\r\nroute.get(\"/archivo/:filename\", (req, res) => {\r\n  const { filename } = req.params;\r\n  \r\n  // Validar que el nombre del archivo sea seguro\r\n  if (!filename || filename.includes('..') || filename.includes('/')) {\r\n    return res.status(400).json({ error: 'Nombre de archivo inválido' });\r\n  }\r\n  \r\n  const filePath = path.join(__dirname, '../../uploads/remitos', filename);\r\n  \r\n  // Verificar que el archivo existe\r\n  if (!fs.existsSync(filePath)) {\r\n    return res.status(404).json({ error: 'Archivo no encontrado' });\r\n  }\r\n  \r\n  res.sendFile(filePath);\r\n});\r\n\r\nmodule.exports = route;\r\n"],"file":"remito.routes.js"}